<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Brexit Commodity Import and Export Network</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="src/components/Transport/Transport.css">
    <link rel="stylesheet" href="src/components/CountryScale/CountryScale.css">
    <link rel="stylesheet" href="src/components/RegionScale/RegionScale.css">
    <link rel="stylesheet" href="src/components/GoodsType/GoodsType.css">
    <link rel="stylesheet" href="src/components/KeyInsights/KeyInsights.css">
    <!-- Mapbox CSS and JS -->
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css' rel='stylesheet' />
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js'></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/scrollama"></script>
    <!-- Add website favicon -->
    <link rel="icon" href="public/img/CASAlogo.svg" type="image/svg+xml">
    <link rel="shortcut icon" href="public/img/CASAlogo.svg" type="image/svg+xml">
    <script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    
    <style>
      /* Video background enhancement effect */
      .video-background {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1000;
        overflow: hidden;
        pointer-events: none;
      }
      
      .video-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          rgba(255, 255, 255, 0.249) 0%,
          rgba(255, 255, 255, 0.15) 10%,
          rgba(255, 255, 255, 0.1) 20%,
          rgba(255, 255, 255, 0.05) 35%,
          rgba(255, 255, 255, 0.02) 50%,
          rgba(0, 0, 0, 0) 70%
        );
        pointer-events: none;
        z-index: 1;
      }
      
      .video-background video {
        position: absolute;
        top: 50%;
        left: 50%;
        min-width: 100%;
        min-height: 100%;
        width: auto;
        height: auto;
        transform: translateX(-50%) translateY(-50%);
        object-fit: cover;
        opacity: 0.25;
        will-change: transform;
        -webkit-backface-visibility: hidden;
        backface-visibility: hidden;
      }
      
      .section-background {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -999;
        overflow: hidden;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.5s ease;
      }
      
      .section-background video {
        position: absolute;
        top: 50%;
        left: 50%;
        min-width: 100%;
        min-height: 100%;
        width: auto;
        height: auto;
        transform: translateX(-50%) translateY(-50%);
        object-fit: cover;
      }
      
      .navbar, .side-nav, .hero-content, .content, .content-transport {
        position: relative;
        z-index: 1;
      }

      .brexit-vote-section {
        padding: 2rem;
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        margin: 2rem auto;
        max-width: 1400px;
        width: 100%;
        box-sizing: border-box;
      }

      .brexit-container {
        display: flex;
        gap: 3rem;
        align-items: flex-start;
        justify-content: center;
        min-height: 600px;
      }

      .brexit-text {
        flex: 0 0 500px;
        padding: 2rem;
        opacity: 0;
        transform: translateX(50px);
        transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        height: 600px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        overflow: hidden;
      }

      .brexit-text h2 {
        color: #fff;
        font-size: 2.8rem; 
        margin-bottom: 2rem; 
      }

      .brexit-text p {
        color: #fff;
        font-size: 1.05rem; 
        line-height: 1.5;
        margin-bottom: 1rem;
      }

      .brexit-text ul {
        color: #fff;
        margin: 1rem 0 5rem; 
        padding-left: 1.2rem;
      }

      .brexit-text li {
        margin: 0.5rem 0; 
        font-size: 1.05rem; 
        line-height: 1.5;
      }

      .brexit-map {
        flex: 0 0 700px;
        height: 600px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 15px;
        position: relative;
        z-index: 10;
        overflow: visible; 
      }

      .uk-outline {
        fill: #2a2a2a;
        stroke: #fff;
        stroke-width: 1;
      }

      .connector {
        stroke: #fff;
        stroke-width: 1;
      }

      .seat {
        stroke: #fff;
        stroke-width: 0.5;
      }

      .seat.remain {
        fill: #00BCD4;
      }

      .seat.leave {
        fill: #F44336;
      }

      .seat.other {
        fill: #FFC107;
      }

      text {
        fill: #fff;
        font-family: 'Inter', sans-serif;
        font-size: 12px;
      }

      .note {
        fill: #aaa;
        font-size: 10px;
      }

      .region {
        transition: opacity 0.3s ease;
      }

      .region:hover {
        opacity: 0.8;
        cursor: pointer;
      }

      .region-marker {
        background: rgba(0, 0, 0, 0.85);
        padding: 8px;
        border-radius: 4px;
        white-space: nowrap;
        color: #fff;
        font-size: 12px;
        pointer-events: auto;
        z-index: 100;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        backdrop-filter: blur(4px);
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      }

      .region-marker.highlight {
        transform: scale(1.1);
        background: rgba(255, 255, 255, 0.95);
        color: #000;
        box-shadow: 0 4px 16px rgba(255, 255, 255, 0.5);
        z-index: 101;
      }

      .region-label {
        margin-bottom: 4px;
        font-weight: 500;
      }

      .vote-distribution {
        display: flex;
        gap: 2px;
      }

      .vote-dot {
        width: 16px;
        height: 16px;
        border-radius: 3px;
      }

      .vote-dot.yellow { background: #f7f48b; }
      .vote-dot.red { background: #F44336; }
      .vote-dot.blue { background: #2196F3; }
      .vote-dot.cyan { background: #00BCD4; }
      .vote-dot.green { background: #4CAF50; }
      .vote-dot.orange { background: #FFC107; }
      .vote-dot.darkgreen { background: #137a2b; }

      .connector-line {
        fill: none;
        stroke: rgba(255, 255, 255, 0.8);
        stroke-width: 1.5;
        pointer-events: none;
        stroke-dasharray: 4,4;
        animation: dash 20s linear infinite;
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      }

      .connector-dot {
        fill: rgba(255, 255, 255, 0.8);
        stroke: rgba(255, 255, 255, 0.4);
        stroke-width: 1;
        pointer-events: none;
        r: 3;
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      }

      .connector-line.fade-in,
      .connector-dot.fade-in {
        opacity: 1;
        transform: translateY(0);
      }

      .connector-group {
        opacity: 0;
        transition: opacity 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      }

      .connector-group.fade-in {
        opacity: 1;
      }

      .brexit-text.visible {
        opacity: 1;
        transform: translateX(0);
      }

      .brexit-text p.visible {
        opacity: 1;
        transform: translateX(0);
      }

      .brexit-text .vote-content,
      .brexit-text .brexit-content {
        opacity: 0;
        transform: translateX(30px);
        transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1);
      }

      .brexit-text .vote-content.visible,
      .brexit-text .brexit-content.visible {
        opacity: 1;
        transform: translateX(0);
      }

      .region-marker.visible {
        opacity: 1;
        transform: translateY(0);
      }

      .connector-group.highlight .connector-line {
        stroke: rgba(255, 255, 255, 1);
        stroke-width: 3;
        stroke-dasharray: none;
        filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.5));
      }

      .connector-group.highlight .connector-dot {
        fill: rgba(255, 255, 255, 1);
        stroke: rgba(255, 255, 255, 0.8);
        r: 5;
        filter: drop-shadow(0 0 4px rgba(255, 255, 255, 0.5));
      }

      .view-toggle {
        position: absolute;
        top: 20px;
        right: 20px;
        display: flex;
        gap: 10px;
        z-index: 100;
      }

      .view-button {
        background: rgba(0, 0, 0, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: #fff;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .view-button:hover {
        background: rgba(0, 0, 0, 0.8);
        border-color: rgba(255, 255, 255, 0.4);
      }

      .view-button.active {
        background: rgba(255, 255, 255, 0.2);
        border-color: rgba(255, 255, 255, 0.6);
      }

      .view-button svg {
        width: 16px;
        height: 16px;
        fill: currentColor;
      }

      @keyframes fadeOut {
        from { opacity: 1; }
        to { opacity: 0; }
      }

      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }

      .fade-out {
        animation: fadeOut 0.5s forwards;
      }

      .fade-in {
        animation: fadeIn 0.5s forwards;
      }

      .party-legend {
        position: absolute;
        top: 20px;
        left: 20px;
        display: flex;
        gap: 8px;
        z-index: 100;
        background: rgba(0, 0, 0, 0.6);
        padding: 8px;
        border-radius: 4px;
        transition: opacity 0.5s ease;
      }

      .party-item {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-size: 12px;
        font-weight: 500;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .party-item.Con { background: #0087DC; }
      .party-item.Bxt { background: #12B6CF; }
      .party-item.Grn { background: #6AB023; }
      .party-item.Lab { background: #DC241f; }
      .party-item.LD { background: #FDBB30; }
      .party-item.PldC { background: #008142; }
      .party-item.SNP { background: #FDF38E; color: #000; }

      .region-fills-hover {
        transition: all 0.2s ease;
      }

      .eu-border {
        fill: none;
        stroke: rgba(33, 150, 243, 0);
        stroke-width: 2;
        pointer-events: none;
        transition: stroke 1s ease;
      }

      .uk-border {
        fill: none;
        stroke: rgba(33, 150, 243, 0);
        stroke-width: 2;
        pointer-events: none;
        transition: all 1s ease;
      }

      .uk-border.highlight {
        stroke: rgba(244, 67, 54, 1);
        stroke-width: 3;
        filter: drop-shadow(0 0 8px rgba(244, 67, 54, 0.5));
      }

      .brexit-notification {
        display: none;
      }

      .brexit-notification::after {
        content: '';
        position: absolute;
        left: -10px;
        top: 50%;
        transform: translateY(-50%);
        border-width: 10px;
        border-style: solid;
        border-color: transparent rgba(0, 0, 0, 0.85) transparent transparent;
      }

      .brexit-notification.visible {
        opacity: 1;
        transform: translateX(0);
      }

      .avatar-frame {
        position: relative;
        width: 200px;
        height: 200px;
        border-radius: 50%;
        padding: 4px;
        background: linear-gradient(135deg, #5eb3f9 0%, #ffffff 100%);
        margin-bottom: 1rem;
      }

      .avatar-img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
      }

      .loading-dots {
        display: inline-block;
        margin-left: 4px;
      }

      .loading-dots span {
        display: inline-block;
        font-size: 24px;
        font-weight: bold;
        color: #edf7ff;
        opacity: 0;
        animation: dotAnimation 1.4s infinite;
        animation-fill-mode: both;
        transform: translateY(-2px);
        margin: 0 2px;
      }

      .loading-dots span:nth-child(2) {
        animation-delay: 0.2s;
      }

      .loading-dots span:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes dotAnimation {
        0% { 
          opacity: 0;
          transform: translateY(-2px) scale(0.8);
        }
        20% { 
          opacity: 1;
          transform: translateY(-2px) scale(1.2);
        }
        100% { 
          opacity: 0;
          transform: translateY(-2px) scale(0.8);
        }
      }
    </style>
  </head>
  <body>
    <!-- Main Video Background (the first video) - Homepage -->
    <div class="video-background" id="main-background">
      <div class="video-overlay"></div>
      <video autoplay muted loop playsinline id="homepage-background-video">
        <source src="https://raw.githubusercontent.com/Cihshee/CASA0003_minnni_project/main/public/1.mp4" type="video/mp4">
        Your browser does not support the video tag.
      </video>
    </div>
    
    <!-- Second Video Background - Other Sections -->
    <div class="section-background" id="sections-background">
      <video autoplay muted loop playsinline id="sections-background-video">
        <source src="https://raw.githubusercontent.com/Cihshee/CASA0003_minnni_project/main/public/2.mp4" type="video/mp4">
        Your browser does not support the video tag.
      </video>
    </div>
    
    <!-- Side Navigation Dots -->
    <div class="side-nav" id="side-nav">
      <div class="side-nav-dot" data-target="section1"></div>
      <div class="side-nav-dot" data-target="section1b"></div>
      <div class="side-nav-dot" data-target="section4"></div>
      <div class="side-nav-dot" data-target="section5"></div>
      <div class="side-nav-dot" data-target="section6"></div>
      <div class="side-nav-dot" data-target="section7"></div>
      <!-- <div class="side-nav-dot" data-target="section8"></div> -->
      <div class="side-nav-dot" data-target="section9"></div>
    </div>
    
    <!-- Load Lottie library and initialize animations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
    <script>
      // Initialize background animation
      document.addEventListener('DOMContentLoaded', function() {
        // Background animation
        const anim = lottie.loadAnimation({
          container: document.getElementById('background-animation'),
          renderer: 'svg',
          loop: true,
          autoplay: false,
          path: 'https://raw.githubusercontent.com/Cihshee/CASA0003_minnni_project/main/public/Chevrons-moving-down.json',
          rendererSettings: {
            preserveAspectRatio: 'xMidYMid slice',
            progressiveLoad: true,
            hideOnTransparent: true
          }
        });
        
        // Set speed after animation loads
        anim.addEventListener('DOMLoaded', function() {
          requestAnimationFrame(() => {
            anim.setSpeed(0.4);
            anim.goToAndPlay(-2000, true);
          });
        });
        
        // Optimize animation container size adjustment
        const resizeAnimation = debounce(() => {
          const container = document.getElementById('background-animation');
          if (container) {
            requestAnimationFrame(() => {
              container.style.width = (window.innerWidth * 0.9) + 'px';
              container.style.height = window.innerHeight + 'px';
              container.style.left = '5%';
              container.style.right = '5%';
            });
          }
        }, 150);
        
        // Call resize and add event listener
        resizeAnimation();
        window.addEventListener('resize', resizeAnimation, { passive: true });
      });
    </script>

    <script>
      // Side nav scroll and highlight logic
      const dots = Array.from(document.querySelectorAll('.side-nav-dot'));
      const sections = [
        'section1','section1b','section4','section5','section6','section7','section8','section9'
      ].map(id => document.getElementById(id));
      
      // Use requestAnimationFrame to optimize scrolling performance
      let ticking = false;
      function updateActiveDot() {
        if (!ticking) {
          requestAnimationFrame(() => {
            let idx = 0;
            const scrollY = window.scrollY || window.pageYOffset;
            for (let i = 0; i < sections.length; i++) {
              if (sections[i]) {
                const rect = sections[i].getBoundingClientRect();
                if (rect.top <= window.innerHeight * 0.33) idx = i;
              }
            }
            dots.forEach((d, i) => d.classList.toggle('active', i === idx));
            
            // Switch background video based on current section
            const mainBackground = document.getElementById('main-background');
            const sectionsBackground = document.getElementById('sections-background');
            
            if (idx <= 1) { // Homepage section shows first video
              mainBackground.style.opacity = 1;
              sectionsBackground.style.opacity = 0;
            } else { // Other sections show second video
              mainBackground.style.opacity = 0;
              sectionsBackground.style.opacity = 1;
            }
            ticking = false;
          });
          ticking = true;
        }
      }

      // Debounce function
      function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }
      
      // Optimize scrolling and size adjustment event listeners
      window.addEventListener('scroll', updateActiveDot, { passive: true });
      window.addEventListener('resize', debounce(updateActiveDot, 150), { passive: true });

      // Call once on initialization
      document.addEventListener('DOMContentLoaded', updateActiveDot);
      
      // Optimize click events
      dots.forEach((dot, i) => {
        dot.addEventListener('click', e => {
          e.preventDefault();
          if (sections[i]) {
            // Use requestAnimationFrame to optimize scrolling
            requestAnimationFrame(() => {
              sections[i].scrollIntoView({behavior:'smooth'});
            });
          }
        });
      });
    </script>

    <!-- Script for the right fixed navigation bar -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const fixedSideNav = document.getElementById('fixed-side-nav');
        const fixedNavLinks = document.querySelectorAll('.fixed-nav-link');
        const sectionsForNav = [
          { id: 'section1', name: 'homepage' },
          { id: 'section4', name: 'overview' },
          { id: 'section5', name: 'partners' },
          { id: 'section6', name: 'commodities' },
          { id: 'section7', name: 'transport' },
          { id: 'section9', name: 'team' }
        ];
        
        const backToTopLink = document.querySelector('.back-to-top');
        if (backToTopLink) {
          backToTopLink.addEventListener('click', function(e) {
            e.preventDefault();
            window.scrollTo({ top: 0, behavior: 'smooth' });
          });
        }
        
        // Collapse/expand navigation bar functionality  
        const toggleNavBtn = document.getElementById('toggle-nav-btn');
        if (toggleNavBtn) {
          toggleNavBtn.addEventListener('click', function() {
            fixedSideNav.classList.toggle('collapsed');
            // Save user's collapsed state preference
            localStorage.setItem('navCollapsed', fixedSideNav.classList.contains('collapsed'));
          });
          
          // Load user's previous collapsed state preference
          const savedCollapsedState = localStorage.getItem('navCollapsed');
          if (savedCollapsedState === 'true') {
            fixedSideNav.classList.add('collapsed');
          }
        }
        
        // Show/hide right navigation bar and update active links on scroll
        function updateFixedSideNav() {
          // Show right navigation bar after scrolling more than 300px
          if (window.scrollY > 300) {
            fixedSideNav.style.display = 'block';
            // Use fade-in animation
            setTimeout(() => {
              fixedSideNav.style.opacity = '1';
            }, 50);
          } else {
            fixedSideNav.style.opacity = '0';
            // Fade out and hide after 300ms
            setTimeout(() => {
              if (window.scrollY <= 300) {
                fixedSideNav.style.display = 'none';
              }
            }, 300);
          }
          
          // Update active links
          let currentSection = '';
          for (const section of sectionsForNav) {
            const el = document.getElementById(section.id);
            if (el && el.getBoundingClientRect().top <= window.innerHeight * 0.33) {
              currentSection = section.name;
            }
          }
          
          fixedNavLinks.forEach(link => {
            const section = link.getAttribute('data-section');
            link.classList.toggle('active', section === currentSection);
          });
        }
        
        window.addEventListener('scroll', updateFixedSideNav);
        window.addEventListener('resize', updateFixedSideNav);
        // Initialize call
        updateFixedSideNav();
      });
    </script>

    <!-- Navigation Bar -->
    <nav class="navbar">
      <ul>
        <li><a href="#section1" class="nav-link">Homepage</a></li>
        <li><a href="#section4" class="nav-link">Overview</a></li>
        <li><a href="#section5" class="nav-link">Trade Partners</a></li>
        <li><a href="#section6" class="nav-link">Key Commodities</a></li>
        <li><a href="#section7" class="nav-link">Transport Modes</a></li>
        <li><a href="#section8" class="nav-link">Key Insights</a></li>
        <li><a href="#section9" class="nav-link">Our Team</a></li>
      </ul>
    </nav>

    <!-- Fixed Floating Navigation Bar -->
    <nav class="fixed-side-nav" id="fixed-side-nav">
      <ul class="fixed-side-menu">
        <li><a href="#section1" class="fixed-nav-link" data-title="Homepage"></a></li>
        <li><a href="#section4" class="fixed-nav-link" data-title="Overview"></a></li>
        <li><a href="#section5" class="fixed-nav-link" data-title="Trade Partners"></a></li>
        <li><a href="#section6" class="fixed-nav-link" data-title="Commodities"></a></li>
        <li><a href="#section7" class="fixed-nav-link" data-title="Transport"></a></li>
        <li><a href="#section8" class="fixed-nav-link" data-title="Insights"></a></li>
        <li><a href="#section9" class="fixed-nav-link" data-title="Team"></a></li>
        <li><a href="#top" class="fixed-nav-link back-to-top" data-title="Back to Top"></a></li>
      </ul>
    </nav>

    <!-- Main Content Area -->
    <main>
      <section id="section1" class="full-page hero-section" style="position:relative;overflow:hidden;display:flex;align-items:flex-start;justify-content:center;min-height:100vh;background:transparent;">
        <div id="threejs-bg" style="position:absolute;left:0;top:0;width:100%;height:100%;z-index:0;pointer-events:none;"></div>
        <!-- Add reflection container -->
        <div id="threejs-reflection" style="position:absolute;left:0;top:100%;width:100%;height:100%;z-index:0;pointer-events:none;transform:scaleY(-1);opacity:0.3;background:linear-gradient(to bottom, rgba(0,0,0,0.1), transparent);"></div>
        <div class="hero-content" style="position:relative;z-index:2;display:flex;flex-direction:column;align-items:flex-start;justify-content:flex-start;max-width:1200px;margin:0 auto;padding-top:2vh;padding-left:0;">
          <div id="lottie-title" style="width:1900px;max-width:99vw;height:450px;min-height:250px;display:flex;align-items:center;justify-content:flex-start;pointer-events:none;margin-bottom:-20px;margin-left:-400px;">
            <div id="lottie-title-player" style="width:1900px;max-width:99vw;height:450px;"></div>
          </div>
          <p class="hero-desc highlight-desc" style="margin-top:-70px;margin-bottom:0;font-size:1.1rem;text-shadow:0 2px 4px rgba(0,0,0,0.8), 0 0 10px rgba(0,0,0,0.7), 0 0 20px rgba(0,0,0,0.7);color:#fff;font-weight:500;text-align:center;width:100%;">
            An Exploration Of The Impact Of Brexit On The Global Commodity Import And Export Trade Network.
          </p>
          <!-- Add Start Explore button -->
          <button id="start-explore-btn" style="margin-top:2.5rem;padding:1rem 2.5rem;font-size:1.2rem;background:rgba(94, 179, 249, 0.2);color:#fff;border:2px solid #5eb3f9;border-radius:30px;cursor:pointer;transition:all 0.3s ease;text-shadow:0 2px 4px rgba(0,0,0,0.5);backdrop-filter:blur(5px);font-weight:700;display:block;margin-left:auto;margin-right:auto;">
            Start Explore
            <svg style="width:20px;height:20px;margin-left:10px;transform:translateY(4px)" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <polyline points="19 12 12 19 5 12"></polyline>
            </svg>
          </button>
        </div>
      </section>

      <section id="section1b" class="full-page hero-section" style="position:relative;overflow:hidden;display:flex;align-items:flex-start;justify-content:center;min-height:60vh;background:transparent;">
        <video autoplay muted loop playsinline id="bg-video"
          style="position:relative;width:60vw;height:auto;max-width:1200px;max-height:100vh;object-fit:cover;z-index:0;border-radius:1.5rem;box-shadow:0 4px 32px rgba(0,0,0,0.18);border:4px solid #444;margin-top:20vh;margin-bottom:10vh;">
          <source src="public/cover.mp4" type="video/mp4">
          Your browser does not support the video tag.
        </video>
      </section>

      <script>
        // Add button click event handling
        document.getElementById('start-explore-btn').addEventListener('click', function() {
          document.getElementById('section1b').scrollIntoView({ 
            behavior: 'smooth',
            block: 'start'
          });
        });

        // Add button hover effect
        const exploreBtn = document.getElementById('start-explore-btn');
        exploreBtn.addEventListener('mouseenter', function() {
          this.style.background = 'rgba(94, 179, 249, 0.4)';
          this.style.transform = 'translateY(-2px)';
          this.style.boxShadow = '0 4px 15px rgba(94, 179, 249, 0.3)';
        });
        exploreBtn.addEventListener('mouseleave', function() {
          this.style.background = 'rgba(94, 179, 249, 0.2)';
          this.style.transform = 'translateY(0)';
          this.style.boxShadow = 'none';
        });

        lottie.loadAnimation({
          container: document.getElementById('lottie-title-player'),
          renderer: 'svg',
          loop: true,
          autoplay: true,
          path: 'https://raw.githubusercontent.com/Cihshee/CASA0003_minnni_project/main/public/Bouncing-period-remix.json'
        });
      </script>

      <section id="section2" class="full-page">
        <div class="content brexit-vote-section" style="padding:2rem;background:rgba(255, 255, 255, 0.05);backdrop-filter:blur(10px);border-radius:20px;margin:1rem auto;max-width:1400px;width:100%;box-sizing:border-box;">
          <div class="brexit-container">
            <div class="brexit-text">
              <h2 style="color: #5eb3f9;">"Brexit"</h2>
              <div class="vote-content">
                <p>In June 2016, the UK held a historic referendum to decide whether to leave the European Union. Subsequently, prolonged negotiations, political fluctuations, and multiple extensions followed.</p>
                <p>It marked the start of profound changes to the UK's economy and trade landscape. 
                  <span style="display: block; text-align: right; font-size: 14px; color: #888; margin: 8px 0; font-style: italic;">
                    Source: <a href="https://www.youtube.com/watch?v=3icgtyEJMfs" target="_blank" style="color: #888; text-decoration: none;">UK Brexit Triumph: EU Election Map</a>
                  </span>
                  And then<span class="loading-dots"><span>.</span><span>.</span><span>.</span></span>
                </p>
              </div>
              <div class="brexit-content">
                <p>It Comes!</p>
                <div class="delayed-content" style="opacity: 0; transform: translateY(20px); transition: all 0.8s ease;">
                  <p>On January 31, 2020, the UK officially said goodbye to the EU. The days of passport-free, frictionless trade were over—trade entered a new era full of rules and challenges. Meanwhile, political views across regions varied widely, adding layers of complexity to future trade negotiations.</p>
                </div>
              </div>
            </div>
            <div id="brexit-map" class="brexit-map">
              <div class="party-legend">
                <div class="party-item Con">Con</div>
                <div class="party-item Bxt">Bxt</div>
                <div class="party-item Grn">Grn</div>
                <div class="party-item Lab">Lab</div>
                <div class="party-item LD">LD</div>
                <div class="party-item PldC">PldC</div>
                <div class="party-item SNP">SNP</div>
              </div>
              <div class="view-toggle">
                <button class="view-button active" data-view="vote">
                  <svg viewBox="0 0 24 24"><path d="M18 13h-.68l-2 2h1.91L19 17H5l1.78-2h2.05l-2-2H6l-3 3v4c0 1.1.89 2 1.99 2H19c1.1 0 2-.89 2-2v-4l-3-3zm-1-5.05l-4.95 4.95-3.54-3.54 4.95-4.95L17 7.95zm-4.24-5.66L6.39 8.66c-.39.39-.39 1.02 0 1.41l4.95 4.95c.39.39 1.02.39 1.41 0l6.36-6.36c.39-.39.39-1.02 0-1.41L14.16 2.3c-.38-.4-1.01-.4-1.4-.01z"/></svg>
                  2016 Vote
                </button>
                <button class="view-button" data-view="brexit">
                  <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
                  2020 Brexit
                </button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <script>
        document.addEventListener('DOMContentLoaded', function() {
          const MAPBOX_TOKEN = 'pk.eyJ1IjoieWl4aW5nLWxpIiwiYSI6ImNtN3FtNWh6YjA0ancybnM4aGxjZnlheTEifQ.sKwaoIMQR65VQmYDbnu2MQ';
          const MAPBOX_STYLE = 'mapbox://styles/yixing-li/cmaa8uo1j00j001sgc3051vxu';

          // Create Map
          mapboxgl.accessToken = MAPBOX_TOKEN;
          const map = new mapboxgl.Map({
            container: 'brexit-map',
            style: MAPBOX_STYLE,
            center: [-2.5, 55.5],
            zoom: 4.5,
            interactive: true,
            boxZoom: false,
            dragRotate: false,
            pitchWithRotate: false,
            touchZoomRotate: false
          });

          // Wait for map style to load
          map.on('style.load', function() {
            // Load EU and UK boundary data
            fetch('https://raw.githubusercontent.com/Cihshee/CASA0003_minnni_project/main/public/data/countries.geojson')
              .then(response => response.json())
              .then(data => {
                console.log('Loaded GeoJSON data:', data);

                // Add data source
                if (!map.getSource('countries')) {
                  map.addSource('countries', {
                    type: 'geojson',
                    data: data
                  });
                }

                // Add EU boundary layer
                if (!map.getLayer('eu-borders')) {
                  map.addLayer({
                    'id': 'eu-borders',
                    'type': 'line',
                    'source': 'countries',
                    'layout': {},
                    'paint': {
                      'line-color': '#2196F3',
                      'line-width': 2,
                      'line-opacity': 0
                    },
                    'filter': ['any',
                      ['==', ['get', 'name'], 'France'],
                      ['==', ['get', 'name'], 'Germany'],
                      ['==', ['get', 'name'], 'Italy'],
                      ['==', ['get', 'name'], 'Spain'],
                      ['==', ['get', 'name'], 'Poland'],
                      ['==', ['get', 'name'], 'Romania'],
                      ['==', ['get', 'name'], 'Netherlands'],
                      ['==', ['get', 'name'], 'Belgium'],
                      ['==', ['get', 'name'], 'Greece'],
                      ['==', ['get', 'name'], 'Czech Republic'],
                      ['==', ['get', 'name'], 'Portugal'],
                      ['==', ['get', 'name'], 'Sweden'],
                      ['==', ['get', 'name'], 'Hungary'],
                      ['==', ['get', 'name'], 'Austria'],
                      ['==', ['get', 'name'], 'Bulgaria'],
                      ['==', ['get', 'name'], 'Denmark'],
                      ['==', ['get', 'name'], 'Finland'],
                      ['==', ['get', 'name'], 'Slovakia'],
                      ['==', ['get', 'name'], 'Ireland'],
                      ['==', ['get', 'name'], 'Croatia'],
                      ['==', ['get', 'name'], 'Lithuania'],
                      ['==', ['get', 'name'], 'Slovenia'],
                      ['==', ['get', 'name'], 'Latvia'],
                      ['==', ['get', 'name'], 'Estonia'],
                      ['==', ['get', 'name'], 'Cyprus'],
                      ['==', ['get', 'name'], 'Luxembourg'],
                      ['==', ['get', 'name'], 'Malta']
                    ]
                  });
                }

                // Add UK boundary layer
                if (!map.getLayer('uk-border')) {
                  map.addLayer({
                    'id': 'uk-border',
                    'type': 'line',
                    'source': 'countries',
                    'layout': {},
                    'paint': {
                      'line-color': '#2196F3',
                      'line-width': 2,
                      'line-opacity': 0
                    },
                    'filter': ['==', ['get', 'name'], 'United Kingdom']
                  });
                }

                // Add EU fill layer
                if (!map.getLayer('eu-fill')) {
                  map.addLayer({
                    'id': 'eu-fill',
                    'type': 'fill',
                    'source': 'countries',
                    'layout': {},
                    'paint': {
                      'fill-color': '#2196F3',
                      'fill-opacity': 0
                    },
                    'filter': ['any',
                      ['==', ['get', 'name'], 'France'],
                      ['==', ['get', 'name'], 'Germany'],
                      ['==', ['get', 'name'], 'Italy'],
                      ['==', ['get', 'name'], 'Spain'],
                      ['==', ['get', 'name'], 'Poland'],
                      ['==', ['get', 'name'], 'Romania'],
                      ['==', ['get', 'name'], 'Netherlands'],
                      ['==', ['get', 'name'], 'Belgium'],
                      ['==', ['get', 'name'], 'Greece'],
                      ['==', ['get', 'name'], 'Czech Republic'],
                      ['==', ['get', 'name'], 'Portugal'],
                      ['==', ['get', 'name'], 'Sweden'],
                      ['==', ['get', 'name'], 'Hungary'],
                      ['==', ['get', 'name'], 'Austria'],
                      ['==', ['get', 'name'], 'Bulgaria'],
                      ['==', ['get', 'name'], 'Denmark'],
                      ['==', ['get', 'name'], 'Finland'],
                      ['==', ['get', 'name'], 'Slovakia'],
                      ['==', ['get', 'name'], 'Ireland'],
                      ['==', ['get', 'name'], 'Croatia'],
                      ['==', ['get', 'name'], 'Lithuania'],
                      ['==', ['get', 'name'], 'Slovenia'],
                      ['==', ['get', 'name'], 'Latvia'],
                      ['==', ['get', 'name'], 'Estonia'],
                      ['==', ['get', 'name'], 'Cyprus'],
                      ['==', ['get', 'name'], 'Luxembourg'],
                      ['==', ['get', 'name'], 'Malta']
                    ]
                  });
                }

                // Add UK fill layer
                if (!map.getLayer('uk-fill')) {
                  map.addLayer({
                    'id': 'uk-fill',
                    'type': 'fill',
                    'source': 'countries',
                    'layout': {},
                    'paint': {
                      'fill-color': '#2196F3',
                      'fill-opacity': 0,
                      'fill-opacity-transition': {
                        duration: 4000
                      },
                      'fill-color-transition': {
                        duration: 6000
                      }
                    },
                    'filter': ['==', ['get', 'name'], 'United Kingdom']
                  });
                }

                // Create notification element
                const notification = document.createElement('div');
                notification.className = 'brexit-notification';
                notification.textContent = 'Brexit Bill Takes Effect';
                notification.style.display = 'none';

                // Create Mapbox marker to place notification box
                const notificationMarker = new mapboxgl.Marker({
                  element: notification,
                  anchor: 'left'
                })
                .setLngLat([-2, 54]) // UK's location
                .addTo(map);

                // Modify the relevant parts in the switchView function
                function switchView(targetView, skipAnimation = false, startHighlight = false) {
                  if (currentView === targetView) return;
                  
                  // Stop automatic highlighting
                  if (window.highlightInterval) {
                    clearInterval(window.highlightInterval);
                    window.highlightInterval = null;
                  }

                  clearAllHighlights();
                  
                  viewButtons.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.view === targetView);
                  });

                  const voteContent = document.querySelector('.vote-content');
                  const brexitContent = document.querySelector('.brexit-content');

                  if (targetView === 'brexit') {
                    // Fade out markers and connection lines
                    markers.forEach(data => {
                      if (data.element) {
                        data.element.classList.add('fade-out');
                        data.group.classList.add('fade-out');
                      }
                    });
                    partyLegend.classList.add('fade-out');

                    setTimeout(() => {
                      brexitContent.classList.add('visible');
                      // Delay 3 seconds to show subsequent content
                      setTimeout(() => {
                        const delayedContent = document.querySelector('.delayed-content');
                        delayedContent.style.opacity = '1';
                        delayedContent.style.transform = 'translateY(0)';
                      }, 3000);
                    }, 400);

                    setTimeout(() => {
                      map.flyTo({
                        ...viewPositions[targetView],
                        essential: true,
                        duration: 1500
                      });

                      // Hide all visual elements
                      markers.forEach(data => {
                        if (data.element) {
                          data.element.style.display = 'none';
                          data.group.style.display = 'none';
                        }
                      });
                      partyLegend.style.display = 'none';
                      
                      document.querySelectorAll('.connector-line, .connector-dot').forEach(el => {
                        el.style.display = 'none';
                      });

                      // Show borders and fills
                      try {
                        map.setPaintProperty('eu-borders', 'line-opacity', 1);
                        map.setPaintProperty('uk-border', 'line-opacity', 1);
                        
                        map.setPaintProperty('eu-fill', 'fill-opacity', 0.2);
                        map.setPaintProperty('uk-fill', 'fill-opacity', 0.2);

                        setTimeout(() => {
                          map.setPaintProperty('uk-border', 'line-color', '#F44336');
                          map.setPaintProperty('uk-border', 'line-width', 3);
                          map.setPaintProperty('uk-fill', 'fill-color', '#F44336');
                        }, 1000);
                      } catch (error) {
                        console.error('Error showing borders:', error);
                      }
                    }, 500);
                  } else {
                    map.flyTo({
                      ...viewPositions[targetView],
                      essential: true
                    });

                    // Hide borders
                    try {
                      map.setPaintProperty('eu-borders', 'line-opacity', 0);
                      map.setPaintProperty('uk-border', 'line-opacity', 0);
                      map.setPaintProperty('eu-fill', 'fill-opacity', 0);
                      map.setPaintProperty('uk-fill', 'fill-opacity', 0);
                      map.setPaintProperty('uk-border', 'line-color', '#2196F3');
                      map.setPaintProperty('uk-fill', 'fill-color', '#2196F3');
                    } catch (error) {
                      console.error('Error hiding borders:', error);
                    }

                    brexitContent.classList.remove('visible');

                    setTimeout(() => {
                      document.querySelectorAll('.connector-line, .connector-dot').forEach(el => {
                        el.style.display = '';
                      });

                      markers.forEach(data => {
                        if (data.element) {
                          data.element.style.display = '';
                          data.group.style.display = '';
                          data.element.classList.remove('fade-out');
                          data.element.classList.add('fade-in');
                          data.group.classList.remove('fade-out');
                          data.group.classList.add('fade-in');
                        }
                      });
                      partyLegend.style.display = '';
                      partyLegend.classList.remove('fade-out');
                      partyLegend.classList.add('fade-in');
                    }, skipAnimation ? 0 : 1000);
                  }

                  currentView = targetView;
                }

                // Update the existing switchView reference
                window.switchView = switchView;
              })
              .catch(error => {
                console.error('Error loading borders:', error);
              });
          });


          // Load four files in parallel and combine the area data`
          Promise.all([
            fetch('https://raw.githubusercontent.com/Cihshee/CASA0003_minnni_project/main/public/data/countries.geojson').then(r => r.json()),
            fetch('https://raw.githubusercontent.com/Cihshee/CASA0003_minnni_project/main/public/data/England_boundaries.json').then(r => r.json()),
            fetch('https://raw.githubusercontent.com/Cihshee/CASA0003_minnni_project/main/public/data/Scotland_boundaries.json').then(r => r.json()),
            fetch('https://raw.githubusercontent.com/Cihshee/CASA0003_minnni_project/main/public/data/Wales_boundaries.json').then(r => r.json())
          ]).then(([countries, englandTopo, scotlandTopo, walesTopo]) => {
            // Ensure all data uses the same coordinate system (WGS84)
            const ireland = countries.features.find(f => f.properties.name === "Ireland");
            
            // Convert TopoJSON to GeoJSON and ensure coordinate system consistency
            const england = topojson.feature(englandTopo, englandTopo.objects[Object.keys(englandTopo.objects)[0]]);
            const scotland = topojson.feature(scotlandTopo, scotlandTopo.objects[Object.keys(scotlandTopo.objects)[0]]);
            const wales = topojson.feature(walesTopo, walesTopo.objects[Object.keys(walesTopo.objects)[0]]);

            // Merge all features
            const features = [];
            if (ireland) features.push(ireland);
            features.push(...england.features);
            features.push(...scotland.features);
            features.push(...wales.features);

            // Add unique ID to each feature
            features.forEach((f, i) => {
              f.id = i;
              // Ensure properties exist
              f.properties = f.properties || {};
            });

            const merged = { 
              type: "FeatureCollection", 
              features,
              crs: {
                type: "name",
                properties: {
                  name: "urn:ogc:def:crs:OGC:1.3:CRS84"
                }
              }
            };

            // Map loaded after adding data source
            map.on('load', function() {
              map.addSource('uk-regions', {
                type: 'geojson',
                data: merged,
                generateId: true
              });

              // Clear all highlight states
              function clearAllHighlights() {
                map.setFilter('region-fills-hover', ['==', ['get', 'EER13NM'], '']);
                markers.forEach(data => {
                  if (data.element) {
                    data.element.classList.remove('highlight');
                    data.element.classList.remove('visible'); // Correct: Remove visible
                    if (data.group) {
                      data.group.classList.remove('highlight');
                    }
                  }
                });
              }

              // Highlight specific regions
              function highlightRegion(regionName) {
                clearAllHighlights();
                
                // Highlight map area
                map.setFilter('region-fills-hover', ['==', ['get', 'EER13NM'], regionName]);
                
                // Highlight corresponding labels and connection lines
                const marker = markers.get(regionName);
                if (marker) {
                  marker.element.classList.add('highlight');
                  marker.element.classList.add('visible'); // Correct: Add visible
                  marker.group.classList.add('highlight');
                }
              }

              // Start automatic highlight animation
              function startAutoHighlight() {
                if (window.highlightInterval) {
                  clearInterval(window.highlightInterval);
                }

                const regions = Array.from(markers.keys());
                let lastRegion = null;

                function getRandomRegion() {
                  let region;
                  do {
                    region = regions[Math.floor(Math.random() * regions.length)];
                  } while (region === lastRegion && regions.length > 1);
                  lastRegion = region;
                  return region;
                }

                // Immediately highlight the first region
                highlightRegion(getRandomRegion());

                // Highlight the first region every 1200ms
                window.highlightInterval = setInterval(() => {
                  if (currentView === 'vote') {
                    highlightRegion(getRandomRegion());
                  } else {
                    clearInterval(window.highlightInterval);
                    window.highlightInterval = null;
                  }
                }, 900); // Change speed from 1200ms to 900ms
              }

              // Add view switching logic
              const viewButtons = document.querySelectorAll('.view-button');
              const partyLegend = document.querySelector('.party-legend');
              let currentView = 'vote';

              // Define camera positions for two views
              const viewPositions = {
                initial: {
                  center: [0, 50],
                  zoom: 3,
                  duration: 1000
                },
                vote: {
                  center: [-2.5, 55.5],
                  zoom: 4.5,
                  duration: 2000
                },
                brexit: {
                  center: [0, 50],
                  zoom: 3,
                  duration: 2000
                }
              };

              // Handle view switching
              function switchView(targetView, skipAnimation = false, startHighlight = false) {
                if (currentView === targetView) return;
                
                // Stop automatic highlighting
                if (window.highlightInterval) {
                  clearInterval(window.highlightInterval);
                  window.highlightInterval = null;
                }

                // Clear all highlight states
                clearAllHighlights();
                
                // Update button status
                viewButtons.forEach(btn => {
                  btn.classList.toggle('active', btn.dataset.view === targetView);
                });

                const voteContent = document.querySelector('.vote-content');
                const brexitContent = document.querySelector('.brexit-content');

                // Start transition animation
                if (targetView === 'brexit') {
                  // Fade out markers and connection lines
                  markers.forEach(data => {
                    if (data.element) {
                      data.element.classList.add('fade-out');
                      data.group.classList.add('fade-out');
                    }
                  });
                  partyLegend.classList.add('fade-out');

                  // Show Brexit content but keep vote content visible
                  setTimeout(() => {
                    brexitContent.classList.add('visible');
                    // Delay 3 seconds to show subsequent content
                    setTimeout(() => {
                      const delayedContent = document.querySelector('.delayed-content');
                      delayedContent.style.opacity = '1';
                      delayedContent.style.transform = 'translateY(0)';
                    }, 1000);
                  }, 400);

                  // Wait for fade out to complete before moving map
                  setTimeout(() => {
                    map.flyTo({
                      ...viewPositions[targetView],
                      essential: true,
                      duration: 1500
                    });

                    // Hide all visual elements
                    markers.forEach(data => {
                      if (data.element) {
                        data.element.style.display = 'none';
                        data.group.style.display = 'none';
                      }
                    });
                    partyLegend.style.display = 'none';
                    
                    // Hide all connection lines and markers
                    document.querySelectorAll('.connector-line, .connector-dot').forEach(el => {
                      el.style.display = 'none';
                    });

                    // Show borders and fills
                    map.setPaintProperty('eu-borders', 'line-opacity', 1);
                    map.setPaintProperty('uk-border', 'line-opacity', 1);
                    
                    // Show fills
                    map.setPaintProperty('eu-fill', 'fill-opacity', 0.2);
                    map.setPaintProperty('uk-fill', 'fill-opacity', 0.2);

                    // Delay changing UK's color
                    setTimeout(() => {
                      console.log('Highlighting UK border'); // Add debug log
                      map.setPaintProperty('uk-border', 'line-color', '#F44336');
                      map.setPaintProperty('uk-border', 'line-width', 3);
                      map.setPaintProperty('uk-fill', 'fill-color', '#F44336');
                    }, 1000);
                  }, 500);
                } else {
                  // Return from Brexit view to Vote view
                  map.flyTo({
                    ...viewPositions[targetView],
                    essential: true
                  });

                  // Hide Brexit content but keep vote content visible
                  brexitContent.classList.remove('visible');

                  // Wait for map movement to complete before showing elements
                  setTimeout(() => {
                    // Show all connection lines and markers
                    document.querySelectorAll('.connector-line, .connector-dot').forEach(el => {
                      el.style.display = '';
                    });

                    markers.forEach(data => {
                      if (data.element) {
                        data.element.style.display = '';
                        data.group.style.display = '';
                        data.element.classList.remove('fade-out');
                        data.element.classList.add('fade-in');
                        data.group.classList.remove('fade-out');
                        data.group.classList.add('fade-in');
                      }
                    });
                    partyLegend.style.display = '';
                    partyLegend.classList.remove('fade-out');
                    partyLegend.classList.add('fade-in');
                  }, skipAnimation ? 0 : 1000);
                }

                currentView = targetView;
              }

              // Add button click event
              viewButtons.forEach(button => {
                button.addEventListener('click', () => {
                  // Do not start highlight animation when manually switching, and clear any existing highlights
                  if (window.highlightInterval) {
                    clearInterval(window.highlightInterval);
                    window.highlightInterval = null;
                  }
                  clearAllHighlights();
                  switchView(button.dataset.view, false, false);
                });
              });

              // Add region fill layer
              map.addLayer({
                'id': 'region-fills',
                'type': 'fill',
                'source': 'uk-regions',
                'layout': {},
                'paint': {
                  'fill-color': 'rgba(0, 0, 0, 0)',
                  'fill-outline-color': 'rgba(255, 255, 255, 0.4)'
                }
              });

              // Add highlight layer
              map.addLayer({
                'id': 'region-fills-hover',
                'type': 'fill',
                'source': 'uk-regions',
                'layout': {},
                'paint': {
                  'fill-color': 'rgba(255, 255, 255, 0.4)',
                  'fill-outline-color': '#ffffff',
                  'fill-opacity': ['case',
                    ['boolean', ['==', ['get', 'EER13NM'], ''], false],
                    0,
                    0.6
                  ]
                },
                'filter': ['==', ['get', 'EER13NM'], '']
              });

              // Voting data, including party abbreviations and colors
              const votingData = {
                "Scotland": { 
                  seats: 6, 
                  distribution: [
                    {party:"SNP", color:"yellow"}, {party:"SNP", color:"yellow"}, {party:"Lab", color:"red"}, 
                    {party:"Lab", color:"red"}, {party:"Lab", color:"red"}, {party:"Con", color:"blue"}
                  ],
                  labelOffset: [40, -50]
                },
                "Northern Ireland": { 
                  seats: 3, 
                  note: "yet to declare",
                  labelOffset: [-90, -20]
                },
                "North East": { 
                  seats: 3, 
                  distribution: [
                    {party:"Bxt", color:"cyan"}, {party:"Bxt", color:"cyan"}, {party:"Lab", color:"red"}
                  ],
                  labelOffset: [120, -40]
                },
                "Yorkshire and The Humber": { 
                  seats: 6, 
                  distribution: [
                    {party:"Bxt", color:"cyan"}, {party:"Bxt", color:"cyan"}, {party:"Bxt", color:"cyan"}, 
                    {party:"Lab", color:"red"}, {party:"Con", color:"blue"}, {party:"LD", color:"orange"}
                  ],
                  labelOffset: [110, -20]
                },
                "North West": { 
                  seats: 8, 
                  distribution: [
                    {party:"Bxt", color:"cyan"}, {party:"Bxt", color:"cyan"}, {party:"Bxt", color:"cyan"}, 
                    {party:"Lab", color:"red"}, {party:"Lab", color:"red"}, {party:"Con", color:"blue"}, 
                    {party:"LD", color:"orange"}, {party:"Grn", color:"green"}
                  ],
                  labelOffset: [-110, -10]
                },
                "West Midlands": { 
                  seats: 7, 
                  distribution: [
                    {party:"Bxt", color:"cyan"}, {party:"Bxt", color:"cyan"}, {party:"Lab", color:"red"}, 
                    {party:"Lab", color:"red"}, {party:"Con", color:"blue"}, {party:"LD", color:"orange"}, 
                    {party:"Grn", color:"green"}
                  ],
                  labelOffset: [-130, 60]
                },
                "Wales": { 
                  seats: 4, 
                  distribution: [
                    {party:"Bxt", color:"cyan"}, {party:"Lab", color:"red"}, {party:"PlaidC", color:"darkgreen"}, 
                    {party:"Con", color:"blue"}
                  ],
                  labelOffset: [-110, -30]
                },
                "South West": { 
                  seats: 6, 
                  distribution: [
                    {party:"Bxt", color:"cyan"}, {party:"Bxt", color:"cyan"}, {party:"Bxt", color:"cyan"}, 
                    {party:"LD", color:"orange"}, {party:"Con", color:"blue"}, {party:"Grn", color:"green"}
                  ],
                  labelOffset: [-60, 70]
                },
                "South East": { 
                  seats: 10, 
                  distribution: [
                    {party:"Bxt", color:"cyan"}, {party:"Bxt", color:"cyan"}, {party:"Bxt", color:"cyan"}, 
                    {party:"Con", color:"blue"}, {party:"Con", color:"blue"}, {party:"LD", color:"orange"}, 
                    {party:"LD", color:"orange"}, {party:"Grn", color:"green"}, {party:"Lab", color:"red"}, 
                    {party:"Lab", color:"red"}
                  ],
                  labelOffset: [130, 30]
                },
                "East Midlands": { 
                  seats: 5, 
                  distribution: [
                    {party:"Bxt", color:"cyan"}, {party:"Bxt", color:"cyan"}, {party:"Con", color:"blue"}, 
                    {party:"Lab", color:"red"}, {party:"LD", color:"orange"}
                  ],
                  labelOffset: [130, 30]
                },
                "East of England": { 
                  seats: 7, 
                  distribution: [
                    {party:"Bxt", color:"cyan"}, {party:"Bxt", color:"cyan"}, {party:"Con", color:"blue"}, 
                    {party:"Con", color:"blue"}, {party:"LD", color:"orange"}, {party:"Grn", color:"green"}, 
                    {party:"Lab", color:"red"}
                  ],
                  labelOffset: [110, -10]
                },
                "London": { 
                  seats: 8, 
                  distribution: [
                    {party:"Lab", color:"red"}, {party:"Lab", color:"red"}, {party:"Lab", color:"red"}, 
                    {party:"Lab", color:"red"}, {party:"LD", color:"orange"}, {party:"LD", color:"orange"}, 
                    {party:"Grn", color:"green"}, {party:"Con", color:"blue"}
                  ],
                  labelOffset: [50, -30]
                }
              };

              // Region name mapping (name in GeoJSON to name in our data)
              const regionNameMapping = {
                "Scotland": "Scotland",
                "Northern Ireland": "Northern Ireland",
                "North East": "North East",
                "Yorkshire and The Humber": "Yorkshire and The Humber",
                "North West": "North West",
                "West Midlands": "West Midlands",
                "Wales": "Wales",
                "South West": "South West",
                "South East": "South East",
                "East Midlands": "East Midlands",
                "East of England": "East of England",
                "London": "London"
              };

              // Create SVG container
              const svgContainer = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
              svgContainer.style.position = 'absolute';
              svgContainer.style.top = '0';
              svgContainer.style.left = '0';
              svgContainer.style.width = '100%';
              svgContainer.style.height = '100%';
              svgContainer.style.pointerEvents = 'none';
              svgContainer.style.zIndex = '99';
              document.getElementById('brexit-map').appendChild(svgContainer);

              // Store all markers and connection lines
              const markers = new Map();
              merged.features.forEach(feature => {
                const regionName = feature.properties.EER13NM;
                if (!regionName) return;
                
                const mappedName = regionNameMapping[regionName];
                const data = votingData[mappedName];
                if (!data) return;

                // Calculate region center point
                const center = turf.center(feature).geometry.coordinates;

                // Create marker container
                const markerEl = document.createElement('div');
                markerEl.className = 'region-marker';
                markerEl.setAttribute('data-region', regionName);

                // Add region name and seat count
                const label = document.createElement('div');
                label.className = 'region-label';
                label.textContent = `${regionName} - ${data.seats}`;
                markerEl.appendChild(label);

                // Add vote distribution
                if (data.distribution) {
                  const distributionEl = document.createElement('div');
                  distributionEl.className = 'vote-distribution';
                  data.distribution.forEach(vote => {
                    const dot = document.createElement('div');
                    dot.className = `vote-dot ${vote.color}`;
                    distributionEl.appendChild(dot);
                  });
                  markerEl.appendChild(distributionEl);
                }

                // Create marker and add to map
                const marker = new mapboxgl.Marker({
                  element: markerEl,
                  offset: data.labelOffset
                })
                .setLngLat(center)
                .addTo(map);

                // Create connector group
                const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                group.setAttribute('class', 'connector-group');
                
                // Create connector line
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('class', 'connector-line');
                group.appendChild(path);

                // Create endpoint circle
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('class', 'connector-dot');
                circle.setAttribute('r', '3');
                group.appendChild(circle);

                svgContainer.appendChild(group);

                // Store marker information
                markers.set(regionName, {
                  marker,
                  center,
                  element: markerEl,
                  line: path,
                  dot: circle,
                  group: group
                });
              });

              // Update connector function
              function updateConnectors() {
                const mapCanvas = map.getCanvas();
                const mapRect = mapCanvas.getBoundingClientRect();

                markers.forEach((data, regionName) => {
                  const { marker, center, line, dot, group, element } = data;
                  if (!marker || !center) return;

                  // Get label element and its position on the map
                  const markerEl = marker.getElement();

                  // Ensure label position calculation is correct
                  try {
                    const markerRect = markerEl.getBoundingClientRect();
                    
                    // Calculate the position of the geographic center point on the screen
                    const centerPoint = map.project(center);
                    const start = {
                      x: centerPoint.x,
                      y: centerPoint.y
                    };

                    // Calculate the bottom center position of the label
                    const end = {
                      x: markerRect.left + markerRect.width / 2 - mapRect.left,
                      y: markerRect.top + markerRect.height - mapRect.top
                    };

                    // Calculate the connector line path
                    // Use a straight line connection
                    const path = `
                      M ${start.x} ${start.y}
                      L ${start.x} ${end.y}
                      L ${end.x} ${end.y}
                    `;

                    // Update path and dot
                    line.setAttribute('d', path);
                    dot.setAttribute('cx', start.x);
                    dot.setAttribute('cy', start.y);
                    
                    // Ensure the connector group is visible
                    group.style.display = 'block';
                    group.style.opacity = '1';
                  } catch (e) {
                    console.error("Error updating connector for region: " + regionName, e);
                  }
                });
              }

              // Listen to map events
              map.on('move', updateConnectors);
              map.on('zoom', updateConnectors);
              map.on('style.load', updateConnectors);
              window.addEventListener('resize', updateConnectors);

              // Update scroll animation, ensuring all elements appear at the same time
              function addScrollAnimation() {
                const brexitSection = document.getElementById('section2');
                const brexitText = document.querySelector('.brexit-text');
                
                const observer = new IntersectionObserver((entries) => {
                  entries.forEach(entry => {
                    if (entry.isIntersecting) {
                      requestAnimationFrame(() => {
                        markers.forEach((data) => {
                          if (data.element) data.element.classList.add('visible');
                          if (data.group) data.group.classList.add('visible');
                        });
                        if (brexitText) {
                          brexitText.classList.add('visible');
                        }
                      });
                      
                      observer.unobserve(entry.target);
                    }
                  });
                }, { threshold: 0.2 });

                observer.observe(brexitSection);
              }

              // Initialize connectors and add scroll animation
              map.once('load', () => {
                updateConnectors();
                addScrollAnimation();
              });

              // Mouse hover interaction
              let hoveredRegionId = null;

              map.on('mousemove', 'region-fills', (e) => {
                if (e.features.length > 0) {
                  if (hoveredRegionId) {
                    map.setFilter('region-fills-hover', ['==', ['get', 'EER13NM'], '']);
                    const prevMarker = markers.get(hoveredRegionId);
                    if (prevMarker) {
                      prevMarker.element.style.transform = '';
                      prevMarker.element.style.boxShadow = '';
                      prevMarker.element.classList.remove('highlight'); // Add: Remove highlight
                      prevMarker.element.classList.remove('visible');
                      prevMarker.group.querySelector('.connector-line').style.stroke = '';
                      prevMarker.group.querySelector('.connector-line').style.strokeWidth = '';
                      prevMarker.group.querySelector('.connector-dot').style.fill = '';
                      prevMarker.group.querySelector('.connector-dot').style.stroke = '';
                      prevMarker.group.querySelector('.connector-dot').setAttribute('r', '3');
                    }
                  }

                  hoveredRegionId = e.features[0].properties.EER13NM;
                  if (hoveredRegionId) {
                    map.setFilter('region-fills-hover', ['==', ['get', 'EER13NM'], hoveredRegionId]);
                    const marker = markers.get(hoveredRegionId);
                    if (marker) {
                      marker.element.style.transform = 'scale(1.05)';
                      marker.element.style.boxShadow = '0 4px 12px rgba(0,0,0,0.5)';
                      marker.element.classList.add('highlight'); // Add: Add highlight
                      marker.element.classList.add('visible');
                      marker.group.querySelector('.connector-line').style.stroke = 'rgba(255, 255, 255, 1)';
                      marker.group.querySelector('.connector-line').style.strokeWidth = '2';
                      marker.group.querySelector('.connector-dot').style.fill = 'rgba(255, 255, 255, 1)';
                      marker.group.querySelector('.connector-dot').style.stroke = 'rgba(255, 255, 255, 0.6)';
                      marker.group.querySelector('.connector-dot').setAttribute('r', '4');
                    }
                  }
                }
              });

              map.on('mouseleave', 'region-fills', () => {
                if (hoveredRegionId) {
                  map.setFilter('region-fills-hover', ['==', ['get', 'EER13NM'], '']);
                  const prevMarker = markers.get(hoveredRegionId);
                  if (prevMarker) {
                    prevMarker.element.style.transform = '';
                    prevMarker.element.style.boxShadow = '';
                    prevMarker.element.classList.remove('highlight');   // Add: Remove highlight
                    prevMarker.element.classList.remove('visible');
                    prevMarker.group.querySelector('.connector-line').style.stroke = '';
                    prevMarker.group.querySelector('.connector-line').style.strokeWidth = '';
                    prevMarker.group.querySelector('.connector-dot').style.fill = '';
                    prevMarker.group.querySelector('.connector-dot').style.stroke = '';
                    prevMarker.group.querySelector('.connector-dot').setAttribute('r', '3');
                  }
                }
                hoveredRegionId = null;
              });

              // Initialize map position and automatic playback sequence
              let hasPlayedSequence = false;

              // Create Intersection Observer to detect the visibility of the map area
              const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                  if (entry.isIntersecting && !hasPlayedSequence) {
                    hasPlayedSequence = true;
                    
                    // Set initial far view position
                    map.jumpTo(viewPositions.initial);
                    
                    // Hide all elements
                    markers.forEach(data => {
                      if (data.element) {
                        data.element.style.display = 'none';
                        data.group.style.display = 'none';
                      }
                    });
                    partyLegend.style.display = 'none';
                    document.querySelectorAll('.connector-line, .connector-dot').forEach(el => {
                      el.style.display = 'none';
                    });

                    // Show 2016 vote content
                    const voteContent = document.querySelector('.vote-content');
                    const brexitContent = document.querySelector('.brexit-content');
                    voteContent.classList.add('visible');
                    brexitContent.classList.remove('visible');

                    // Start animation sequence
                    setTimeout(() => {
                      map.flyTo({
                        ...viewPositions.vote,
                        duration: 1500
                      });
                      
                      setTimeout(() => {
                        markers.forEach(data => {
                          if (data.element) {
                            data.element.style.display = '';
                            data.element.classList.add('fade-in');
                            if (data.group) {
                              data.group.style.display = '';
                              data.group.classList.add('fade-in');
                            }
                          }
                        });
                        
                        partyLegend.style.display = '';
                        partyLegend.classList.add('fade-in');
                        
                        document.querySelectorAll('.connector-line, .connector-dot').forEach(el => {
                          el.style.display = '';
                          el.classList.add('fade-in');
                        });
                        
                        updateConnectors();
                        
                        setTimeout(() => {
                          startAutoHighlight();
                          
                          setTimeout(() => {
                            switchView('brexit', false, false);
                          }, 5000); // Increase waiting time from 2000ms to 5000ms
                        }, 400);
                      }, 1500);
                    }, 500);
                  }
                });
              }, { threshold: 0.5 });

              // Start observing the map container
              observer.observe(document.getElementById('brexit-map'));

              // Add mouse hover pause automatic highlight function
              map.on('mousemove', 'region-fills', (e) => {
                if (e.features.length > 0) {
                  // Pause automatic highlight
                  if (window.highlightInterval) {
                    clearInterval(window.highlightInterval);
                    window.highlightInterval = null;
                  }

                  const regionName = e.features[0].properties.EER13NM;
                  if (regionName) {
                    highlightRegion(regionName);
                  }
                }
              });

              map.on('mouseleave', 'region-fills', () => {
                // Only resume automatic highlight in the initial animation sequence
                if (currentView === 'vote' && !window.highlightInterval && !hasPlayedSequence) {
                  startAutoHighlight();
                }
              });
            });
          });
        });
      </script>

      <section id="section4" class="full-page" style="margin-top:-2rem;">
        <div class="content">
          <!-- Use Country Scale component -->
          <div id="country-scale-container"></div>
        </div>
      </section>

      <section id="section5" class="full-page"> 
        <div class="content">
          <!-- Use Region Scale component -->
          <div id="region-scale-container"></div>
        </div>
      </section>

      <section id="section6" class="full-page">
        <div class="content">
          <div id="goods-types-container"></div>
          <div id="goods-type-detail-section"></div>
        </div>
      </section>

      <section id="section7" class="full-page" style="min-height: 100vh;">
        <div class="content-transport">
          <!-- Use Transportation component -->
          <div id="transport-container"></div>
        </div>
      </section>

      <section id="section8" class="full-page">
        <div class="content">
          <!-- Use Key Insights component -->
          <div id="key-insights-container"></div>
        </div>
      </section>

    <script>
        // Load Country Scale component
        fetch('src/components/CountryScale/CountryScale.html')
        .then(response => response.text())
        .then(html => {
            document.getElementById('country-scale-container').innerHTML = html;
          const script = document.createElement('script');
            script.src = 'src/components/CountryScale/CountryScale.js';
          document.body.appendChild(script);
        });

      // Load Region Scale component
        fetch('src/components/RegionScale/RegionScale.html')
          .then(response => response.text())
          .then(html => {
            document.getElementById('region-scale-container').innerHTML = html;
            const script = document.createElement('script');
            script.src = 'src/components/RegionScale/RegionScale.js';
            document.body.appendChild(script);
          });

      // Load Goods Types component
        fetch('src/components/GoodsType/GoodsType.html')
          .then(response => response.text())
          .then(html => {
            document.getElementById('goods-types-container').innerHTML = html;
            const script = document.createElement('script');
            script.src = 'src/components/GoodsType/GoodsType.js';
            document.body.appendChild(script);
          });

      // Load Transportation component
      fetch('src/components/Transport/Transport.html')
        .then(response => response.text())
        .then(html => {
          document.getElementById('transport-container').innerHTML = html;
          const script = document.createElement('script');
          script.src = 'src/components/Transport/Transport.js';
            document.body.appendChild(script);
          });

      // Load Key Insights component and ensure style sheet is loaded
        fetch('src/components/KeyInsights/KeyInsights.html')
        .then(response => response.text())
        .then(html => {
          document.getElementById('key-insights-container').innerHTML = html;
          
          // Ensure the CSS is loaded
          if (!document.querySelector('link[href="src/components/KeyInsights/KeyInsights.css"]')) {
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = 'src/components/KeyInsights/KeyInsights.css';
            document.head.appendChild(link);
          }
          
          // Add inline script to ensure global D3 is available
          const checkD3Script = document.createElement('script');
          checkD3Script.textContent = `
            if (typeof d3 === 'undefined') {
              console.log('Global D3 not found, loading...');
              const d3Script = document.createElement('script');
              d3Script.src = 'https://d3js.org/d3.v7.min.js';
              d3Script.onload = function() {
                console.log('D3 loaded, now loading KeyInsights.js');
                loadKeyInsightsScript();
              };
              document.head.appendChild(d3Script);
            } else {
              console.log('D3 loaded, directly loading KeyInsights.js');
              loadKeyInsightsScript();
            }
            
            function loadKeyInsightsScript() {
              const script = document.createElement('script');
              script.src = 'src/components/KeyInsights/KeyInsights.js';
              document.body.appendChild(script);
            }
          `;
          document.body.appendChild(checkD3Script);
        });
    </script>

      <section id="section9" class="full-page">
        <style>
          .avatar-frame {
            position: relative;
            width: 200px;
            height: 200px;
            border-radius: 50%;
            padding: 4px;
            background: linear-gradient(135deg, #5eb3f9 0%, #ffffff 100%);
            margin-bottom: 1rem;
          }

          .avatar-img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
          }
        </style>
        
        <div class="content">
          <h2 class="section-title">Our Team</h2>
          <div class="team-container">
            <div class="team-member">
              <div class="avatar-frame">
                <img src="public/img/team/cui.png" alt="team1" class="avatar-img">
              </div>
              <h3 class="member-name">Yiyao Cui</h3>
              <a href="https://github.com/Cihshee" class="member-link" target="_blank">Github page</a>
            </div>
            <div class="team-member">
              <div class="avatar-frame">
                <img src="public/img/team/chu.png" alt="team2" class="avatar-img">
              </div>
              <h3 class="member-name">Tianqi Chu</h3>
              <a href="https://github.com/vicky424" class="member-link" target="_blank">Github page</a>
            </div>
            <div class="team-member">
              <div class="avatar-frame">
                <img src="public/img/team/li.jpg" alt="team3" class="avatar-img">
              </div>
              <h3 class="member-name">Yixing(Vera) Li</h3>
              <a href="https://github.com/VeraLi0710" class="member-link" target="_blank">Github page</a>
            </div>
            <div class="team-member">
              <div class="avatar-frame">
                <img src="public/img/team/liu.png" alt="team4" class="avatar-img">
              </div>
              <h3 class="member-name">Scarlett Liu</h3>
              <a href="https://github.com/Scarlett-Cococo" class="member-link" target="_blank">Github page</a>
            </div>
          </div>
          <div class="footer-links">
            <a href="https://github.com/Cihshee/CASA0003_minnni_project" class="icon-link" target="_blank">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
              </svg>
            </a>
            <a href="https://www.ucl.ac.uk/bartlett/casa/" class="icon-link" target="_blank">
              <img src="public/img/CASAlogo.png" alt="CASA Logo" class="casa-logo">
            </a>
          </div>
          <div class="copyright">
            Copyright © Centre for Advanced Spatial Analysis, University College London 2025
          </div>
        </div>
      </section>
    </main>

    <script src="script.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      // Delete the original code for automatic adsorption and automatic sliding functions
      // Only keep the basic part for normal operation of the side navigation points
      (function() {
        const sections = Array.from(document.querySelectorAll('.full-page'));
        
        function findCurrentSection() {
          let idx = 0;
          for (let i = 0; i < sections.length; i++) {
            const rect = sections[i].getBoundingClientRect();
            if (rect.top <= window.innerHeight * 0.33) idx = i;
          }
          return idx;
        }
        
        // Keep the scroll position listener to update the side navigation point status
        window.addEventListener('scroll', function() {
          const currentIdx = findCurrentSection();
          const dots = Array.from(document.querySelectorAll('.side-nav-dot'));
          dots.forEach((d, i) => d.classList.toggle('active', i === currentIdx));
        });
        
        // Keep the function of clicking the side navigation point, but use normal scrolling
        const dots = Array.from(document.querySelectorAll('.side-nav-dot'));
        dots.forEach((dot, i) => {
          dot.addEventListener('click', e => {
            e.preventDefault();
            const sectionId = dot.getAttribute('data-target');
            const section = document.getElementById(sectionId);
            if (section) {
              window.scrollTo({
                top: section.offsetTop,
                behavior: 'smooth'
              });
            }
          });
        });
      })();
    </script>

    <!-- Add a script to handle the automatic click of the Transport Modes navigation button when returning from uk-port.html -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Check if there is a mark in localStorage that needs to click the Transport button
        if (localStorage.getItem('autoClickTransport') === 'true') {
          // Clear the mark to prevent it from being triggered again when the page is refreshed
          localStorage.removeItem('autoClickTransport');
          
          // Delay 1000 milliseconds to ensure the page is fully loaded
          setTimeout(() => {
            // Find and click the Transport Modes navigation button
            const transportLink = document.querySelector('a[href="#section7"]');
            if (transportLink) {
              transportLink.click();
              console.log('Automatically clicked the Transport Modes navigation button, delayed by 2000ms');
            }
          }, 2000);
        }
      });
    </script>

    <!-- three.js foggy city background script, only rendered to the homepage section1 -->
    <script type="module">
      import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.153.0/+esm';
      
      (function() {
        const bgDiv = document.getElementById('threejs-bg');
        if (!bgDiv) return;
        let width = bgDiv.offsetWidth, height = bgDiv.offsetHeight;
        // three.js scene
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0xcad6e6, 0.018);
        const camera = new THREE.PerspectiveCamera(60, width/height, 1, 1000);
        camera.position.set(0, 40, 120);
        const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
        renderer.setClearColor(0xcad6e6, 0);
        renderer.setSize(width, height);
        bgDiv.appendChild(renderer.domElement);
        // Create city
        const city = new THREE.Group();
        for (let i = 0; i < 400; i++) {
          const geometry = new THREE.BoxGeometry(4, Math.random()*30+10, 4);
          const material = new THREE.MeshLambertMaterial({ color: 0x3a3a3a });
          const mesh = new THREE.Mesh(geometry, material);
          mesh.position.x = (Math.random()-0.5)*200;
          mesh.position.z = (Math.random()-0.5)*200;
          mesh.position.y = geometry.parameters.height/2 - 10;
          city.add(mesh);
        }
        scene.add(city);
        // Lights
        const light = new THREE.DirectionalLight(0xffffff, 0.7);
        light.position.set(100, 200, 100);
        scene.add(light);
        scene.add(new THREE.AmbientLight(0xffffff, 0.5));
        // Fog plane - use program-generated texture instead of external image
        const fogMaterial = new THREE.MeshLambertMaterial({
          color: 0xffffff,
          transparent: true,
          opacity: 0.3,
          depthWrite: false
        });
        
        // Create programmatic fog texture - replace external image
        const canvas = document.createElement('canvas');
        canvas.width = 512;
        canvas.height = 512;
        const ctx = canvas.getContext('2d');
        // Create radial gradient
        const gradient = ctx.createRadialGradient(256, 256, 0, 256, 256, 256);
        gradient.addColorStop(0, 'rgba(255, 255, 255, 0.8)');
        gradient.addColorStop(0.5, 'rgba(255, 255, 255, 0.3)');
        gradient.addColorStop(1, 'rgba(255, 255, 255, 0)');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, 512, 512);
        
        // Add some noise
        for (let i = 0; i < 5000; i++) {
          const x = Math.random() * 512;
          const y = Math.random() * 512;
          const r = Math.random() * 1.5;
          ctx.beginPath();
          ctx.arc(x, y, r, 0, Math.PI * 2);
          ctx.fillStyle = `rgba(255, 255, 255, ${Math.random() * 0.1})`;
          ctx.fill();
        }
        
        // Use canvas as texture
        const fogTexture = new THREE.CanvasTexture(canvas);
        fogMaterial.map = fogTexture;
        
        const fogPlane = new THREE.Mesh(
          new THREE.PlaneGeometry(400, 400),
          fogMaterial
        );
        fogPlane.position.y = 5;
        fogPlane.rotation.x = -Math.PI/2;
        scene.add(fogPlane);
        // Animation
        function animate() {
          city.rotation.y += 0.0008;
          renderer.render(scene, camera);
          requestAnimationFrame(animate);
        }
        animate();
        // Respond to window size
        window.addEventListener('resize', function() {
          width = bgDiv.offsetWidth;
          height = bgDiv.offsetHeight;
          camera.aspect = width/height;
          camera.updateProjectionMatrix();
          renderer.setSize(width, height);
        });
      })();
    </script>

    <script>
      // Add after three.js initialization
      (function() {
        const bgDiv = document.getElementById('threejs-bg');
        const reflectionDiv = document.getElementById('threejs-reflection');
        
        // Listen to three.js rendering
        const observer = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
              // When the three.js canvas is added, clone it to the reflection container
              const canvas = bgDiv.querySelector('canvas');
              if (canvas && !reflectionDiv.querySelector('canvas')) {
                const reflectionCanvas = canvas.cloneNode(true);
                reflectionDiv.appendChild(reflectionCanvas);
              }
            }
          });
        });
        
        observer.observe(bgDiv, { childList: true });
      })();
    </script>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Add interactive effects
        const regions = document.querySelectorAll('g[id]');
        regions.forEach(region => {
          region.addEventListener('mouseover', function() {
            this.style.opacity = '0.8';
          });
          region.addEventListener('mouseout', function() {
            this.style.opacity = '1';
          });
        });

        // Add connection line animation
        const lines = document.querySelectorAll('.connection-line');
        lines.forEach(line => {
          line.style.strokeDashoffset = '4';
          line.style.animation = 'dash 20s linear infinite';
        });
      });
    </script>

    <script>
      // Clear all highlight states
      function clearAllHighlights() {
        map.setFilter('region-fills-hover', ['==', ['get', 'EER13NM'], '']);
        markers.forEach(data => {
          if (data.element) {
            data.element.classList.remove('highlight');
            data.element.classList.remove('visible'); // Correct: Remove visible
            if (data.group) {
              data.group.classList.remove('highlight');
            }
          }
        });
      }

      // Highlight specific region
      function highlightRegion(regionName) {
        clearAllHighlights();
        
        // Highlight map area
        map.setFilter('region-fills-hover', ['==', ['get', 'EER13NM'], regionName]);
        
        // Highlight the corresponding label and connection line
        const marker = markers.get(regionName);
        if (marker) {
          marker.element.classList.add('highlight');
          marker.element.classList.add('visible'); // Correct: Add visible
          marker.group.classList.add('highlight');
        }
      }

      // Start automatic highlight animation
      function startAutoHighlight() {
        if (window.highlightInterval) {
          clearInterval(window.highlightInterval);
        }

        const regions = Array.from(markers.keys());
        let lastRegion = null;

        function getRandomRegion() {
          let region;
          do {
            region = regions[Math.floor(Math.random() * regions.length)];
          } while (region === lastRegion && regions.length > 1);
          lastRegion = region;
          return region;
        }

        // Immediately highlight the first region
        highlightRegion(getRandomRegion());

        // Highlight a new region every 1200ms
        window.highlightInterval = setInterval(() => {
          if (currentView === 'vote') {
            highlightRegion(getRandomRegion());
          } else {
            clearInterval(window.highlightInterval);
            window.highlightInterval = null;
          }
        }, 900); // Speed changed from 1200ms to 900ms
      }

      // Add automatic highlight startup in the initial animation sequence
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting && !hasPlayedSequence) {
            hasPlayedSequence = true;
            
            // ... existing initial animation code ...
            
            setTimeout(() => {
              map.flyTo({
                ...viewPositions.vote,
                duration: 1500
              });
              
              setTimeout(() => {
                // ... existing element show code ...
                
                // Start automatic highlight
                setTimeout(() => {
                  startAutoHighlight();
                }, 500);
                
                setTimeout(() => {
                  switchView('brexit');
                }, 2000);
              }, 1500);
            }, 500);
          }
        });
      }, { threshold: 0.5 });

      // Add mouse hover pause automatic highlight function
      map.on('mousemove', 'region-fills', (e) => {
        if (e.features.length > 0) {
          // Pause automatic highlight
          if (window.highlightInterval) {
            clearInterval(window.highlightInterval);
            window.highlightInterval = null;
          }

          const regionName = e.features[0].properties.EER13NM;
          if (regionName) {
            highlightRegion(regionName);
          }
        }
      });

      map.on('mouseleave', 'region-fills', () => {
        // Only resume automatic highlight in the initial animation sequence
        if (currentView === 'vote' && !window.highlightInterval && !hasPlayedSequence) {
          startAutoHighlight();
        }
      });
    </script>
  </body>
</html>
