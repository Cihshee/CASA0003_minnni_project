<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Brexit Commodity Import and Export Network</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="src/components/Transport/Transport.css">
    <link rel="stylesheet" href="src/components/CountryScale/CountryScale.css">
    <link rel="stylesheet" href="src/components/RegionScale/RegionScale.css">
    <link rel="stylesheet" href="src/components/GoodsType/GoodsType.css">
    <!-- Mapbox CSS and JS -->
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css' rel='stylesheet' />
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js'></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/scrollama"></script>
    <!-- 添加网站favicon -->
    <link rel="icon" href="public/img/CASAlogo.svg" type="image/svg+xml">
    <link rel="shortcut icon" href="public/img/CASAlogo.svg" type="image/svg+xml">
    
    <style>
      /* 视频背景增强效果 */
      .video-background {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1000;
        overflow: hidden;
        pointer-events: none;
      }
      
      .video-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          rgba(255, 255, 255, 0.249) 0%,
          rgba(255, 255, 255, 0.15) 10%,
          rgba(255, 255, 255, 0.1) 20%,
          rgba(255, 255, 255, 0.05) 35%,
          rgba(255, 255, 255, 0.02) 50%,
          rgba(0, 0, 0, 0) 70%
        );
        pointer-events: none;
        z-index: 1;
      }
      
      .video-background video {
        position: absolute;
        top: 50%;
        left: 50%;
        min-width: 100%;
        min-height: 100%;
        width: auto;
        height: auto;
        transform: translateX(-50%) translateY(-50%);
        object-fit: cover;
        opacity: 0.25;
        will-change: transform;
        -webkit-backface-visibility: hidden;
        backface-visibility: hidden;
      }
      
      /* 为各部分增加专属背景 */
      .section-background {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -999;
        overflow: hidden;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.5s ease;
      }
      
      .section-background video {
        position: absolute;
        top: 50%;
        left: 50%;
        min-width: 100%;
        min-height: 100%;
        width: auto;
        height: auto;
        transform: translateX(-50%) translateY(-50%);
        object-fit: cover;
      }
      
      /* 确保所有内容有一个正的z-index */
      .navbar, .side-nav, .hero-content, .content, .content-transport {
        position: relative;
        z-index: 1;
      }

      .brexit-vote-section {
        padding: 2rem;
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        margin: 2rem auto;
        max-width: 1400px;
      }

      .brexit-container {
        display: flex;
        gap: 4rem;
        align-items: center;
        justify-content: space-between;
      }

      .brexit-text {
        flex: 1;
        padding: 2rem;
      }

      .brexit-text h2 {
        color: #fff;
        font-size: 2.5rem;
        margin-bottom: 1.5rem;
      }

      .brexit-text p {
        color: #fff;
        font-size: 1.1rem;
        line-height: 1.6;
        margin-bottom: 1rem;
      }

      .brexit-text ul {
        color: #fff;
        margin: 1rem 0;
        padding-left: 1.5rem;
      }

      .brexit-text li {
        margin: 0.5rem 0;
        font-size: 1.1rem;
      }

      .brexit-map {
        flex: 1;
        height: 600px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 15px;
        overflow: visible;
        position: relative;
        z-index: 10;
      }

      .uk-outline {
        fill: #2a2a2a;
        stroke: #fff;
        stroke-width: 1;
      }

      .connector {
        stroke: #fff;
        stroke-width: 1;
      }

      .seat {
        stroke: #fff;
        stroke-width: 0.5;
      }

      .seat.remain {
        fill: #00BCD4;
      }

      .seat.leave {
        fill: #F44336;
      }

      .seat.other {
        fill: #FFC107;
      }

      text {
        fill: #fff;
        font-family: 'Inter', sans-serif;
        font-size: 12px;
      }

      .note {
        fill: #aaa;
        font-size: 10px;
      }

      .region {
        transition: opacity 0.3s ease;
      }

      .region:hover {
        opacity: 0.8;
        cursor: pointer;
      }

      .region-marker {
        background: rgba(0, 0, 0, 0.85);
        padding: 8px 12px;
        border-radius: 6px;
        white-space: nowrap;
        opacity: 0;
        animation: fadeIn 0.5s ease forwards;
        position: relative;
        transition: all 0.3s ease;
        z-index: 20;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        backdrop-filter: blur(4px);
      }

      .region-marker:hover {
        transform: scale(1.05) !important;
        z-index: 30;
      }

      .marker-container {
        width: 0;
        height: 0;
      }

      .connector-line {
        opacity: 0;
        animation: fadeIn 0.5s ease forwards 0.3s;
      }

      .region-marker::before {
        content: '';
        position: absolute;
        width: 2px;
        height: 40px;
        background: rgba(255, 255, 255, 0.5);
        left: 50%;
        bottom: 100%;
        transform: scaleY(0);
        transform-origin: bottom;
        animation: lineGrow 0.5s ease forwards;
        animation-delay: 0.3s;
      }

      .region-marker::after {
        content: '';
        position: absolute;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: white;
        left: calc(50% - 4px);
        bottom: calc(100% + 40px);
        opacity: 0;
        animation: dotAppear 0.3s ease forwards;
        animation-delay: 0.8s;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes lineGrow {
        from {
          transform: scaleY(0);
        }
        to {
          transform: scaleY(1);
        }
      }

      @keyframes dotAppear {
        from {
          opacity: 0;
          transform: scale(0);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      .region-label {
        color: white;
        font-size: 14px;
        margin-bottom: 6px;
        font-weight: 500;
      }

      .region-note {
        color: #aaa;
        font-size: 12px;
        font-style: italic;
      }

      .vote-distribution {
        display: flex;
        gap: 3px;
        justify-content: center;
      }

      .vote-dot {
        width: 14px;
        height: 14px;
        border-radius: 3px;
        display: inline-block;
        transition: transform 0.2s ease;
      }

      .vote-dot.remain {
        background-color: #00BCD4;
      }

      .vote-dot.leave {
        background-color: #F44336;
      }

      .vote-dot.other {
        background-color: #FFC107;
      }

      .region-marker:hover {
        transform: translateY(-5px) scale(1.05);
        background: rgba(0, 0, 0, 0.85);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }

      .region-marker:hover .vote-dot {
        transform: scale(1.1);
      }

      .region-stats {
        display: none;
        margin-top: 8px;
        padding-top: 8px;
        border-top: 1px solid rgba(255, 255, 255, 0.2);
        font-size: 12px;
        color: #fff;
      }

      .region-marker:hover .region-stats {
        display: block;
      }

      .stats-row {
        display: flex;
        justify-content: space-between;
        margin: 4px 0;
      }

      .stats-label {
        color: #aaa;
      }

      /* 为高亮状态添加样式 */
      .region-marker.highlight {
        transform: scale(1.1) !important;
        box-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
        z-index: 100;
        background: rgba(0, 0, 0, 0.9);
      }
      
      .region-marker.highlight .region-stats {
        display: block !important;
      }
      
      .connector-line {
        position: absolute;
        width: 2px;
        background: rgba(255, 255, 255, 0.5);
        transform-origin: top;
        top: 0;
        left: 0;
        opacity: 0;
        animation: fadeIn 0.5s ease forwards 0.3s;
      }
      
      .marker-container {
        width: 0;
        height: 0;
        position: relative;
      }
      
      .region-marker {
        position: absolute;
        background: rgba(0, 0, 0, 0.85);
        padding: 8px 12px;
        border-radius: 6px;
        white-space: nowrap;
        opacity: 0;
        animation: fadeIn 0.5s ease forwards;
        transition: all 0.3s ease;
        z-index: 20;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        backdrop-filter: blur(4px);
      }
    </style>
  </head>
  <body>
    <!-- 主视频背景（第一个视频）- 首页 -->
    <div class="video-background" id="main-background">
      <div class="video-overlay"></div>
      <video autoplay muted loop playsinline id="homepage-background-video">
        <source src="https://raw.githubusercontent.com/Cihshee/CASA0003_minnni_project/main/public/1.mp4" type="video/mp4">
        Your browser does not support the video tag.
      </video>
    </div>
    
    <!-- 第二个视频背景 - 其他部分 -->
    <div class="section-background" id="sections-background">
      <video autoplay muted loop playsinline id="sections-background-video">
        <source src="https://raw.githubusercontent.com/Cihshee/CASA0003_minnni_project/main/public/2.mp4" type="video/mp4">
        Your browser does not support the video tag.
      </video>
    </div>
    
    <!-- Side Navigation Dots -->
    <div class="side-nav" id="side-nav">
      <div class="side-nav-dot" data-target="section1"></div>
      <div class="side-nav-dot" data-target="section1b"></div>
      <div class="side-nav-dot" data-target="section4"></div>
      <div class="side-nav-dot" data-target="section5"></div>
      <div class="side-nav-dot" data-target="section6"></div>
      <div class="side-nav-dot" data-target="section7"></div>
      <!-- <div class="side-nav-dot" data-target="section8"></div> -->
      <div class="side-nav-dot" data-target="section9"></div>
    </div>
    
    <!-- Load Lottie library and initialize animations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
    <script>
      // Initialize background animation
      document.addEventListener('DOMContentLoaded', function() {
        // Background animation
        const anim = lottie.loadAnimation({
          container: document.getElementById('background-animation'),
          renderer: 'svg',
          loop: true,
          autoplay: true,
          path: 'https://raw.githubusercontent.com/Cihshee/CASA0003_minnni_project/main/public/Chevrons-moving-down.json',
          rendererSettings: {
            preserveAspectRatio: 'xMidYMid slice',
            className: 'lottie-svg-fullscreen'
          }
        });
        
        // 在动画加载完成后减慢速度
        anim.addEventListener('DOMLoaded', function() {
          // 设置为0.3倍速，使动画更慢
          anim.setSpeed(0.3);
          console.log('Animation speed set to 0.3');
        });
        
        // Ensure the animation container covers the desired viewport area
        function resizeAnimation() {
          const container = document.getElementById('background-animation');
          container.style.width = (window.innerWidth * 0.9) + 'px';
          container.style.height = window.innerHeight + 'px';
          container.style.left = '5%';
          container.style.right = '5%';
        }
        
        // Call resize on load and on window resize
        resizeAnimation();
        window.addEventListener('resize', resizeAnimation);
      });
    </script>

    <script>
      // Side nav scroll and highlight logic
      const dots = Array.from(document.querySelectorAll('.side-nav-dot'));
      const sections = [
        'section1','section1b','section4','section5','section6','section7','section8','section9'
      ].map(id => document.getElementById(id));
      
      function updateActiveDot() {
        let idx = 0;
        const scrollY = window.scrollY || window.pageYOffset;
        for (let i = 0; i < sections.length; i++) {
          if (sections[i]) {
            const rect = sections[i].getBoundingClientRect();
            if (rect.top <= window.innerHeight * 0.33) idx = i;
          }
        }
        dots.forEach((d, i) => d.classList.toggle('active', i === idx));
        
        // 根据当前部分切换背景视频
        const mainBackground = document.getElementById('main-background');
        const sectionsBackground = document.getElementById('sections-background');
        
        if (idx <= 1) { // 首页部分显示第一个视频
          mainBackground.style.opacity = 1;
          sectionsBackground.style.opacity = 0;
        } else { // 其他部分显示第二个视频
          mainBackground.style.opacity = 0;
          sectionsBackground.style.opacity = 1;
        }
      }
      
      window.addEventListener('scroll', updateActiveDot);
      window.addEventListener('resize', updateActiveDot);
      // 初始化时立即调用一次
      document.addEventListener('DOMContentLoaded', updateActiveDot);
      
      dots.forEach((dot, i) => {
        dot.addEventListener('click', e => {
          e.preventDefault();
          if (sections[i]) sections[i].scrollIntoView({behavior:'smooth'});
        });
      });
    </script>

    <!-- 右侧固定导航栏的脚本 -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const fixedSideNav = document.getElementById('fixed-side-nav');
        const fixedNavLinks = document.querySelectorAll('.fixed-nav-link');
        const sectionsForNav = [
          { id: 'section1', name: 'homepage' },
          { id: 'section4', name: 'overview' },
          { id: 'section5', name: 'partners' },
          { id: 'section6', name: 'commodities' },
          { id: 'section7', name: 'transport' },
          { id: 'section9', name: 'team' }
        ];
        
        const backToTopLink = document.querySelector('.back-to-top');
        if (backToTopLink) {
          backToTopLink.addEventListener('click', function(e) {
            e.preventDefault();
            window.scrollTo({ top: 0, behavior: 'smooth' });
          });
        }
        
        // 折叠/展开导航栏功能
        const toggleNavBtn = document.getElementById('toggle-nav-btn');
        if (toggleNavBtn) {
          toggleNavBtn.addEventListener('click', function() {
            fixedSideNav.classList.toggle('collapsed');
            // 保存用户折叠状态的偏好
            localStorage.setItem('navCollapsed', fixedSideNav.classList.contains('collapsed'));
          });
          
          // 加载用户之前的折叠状态偏好
          const savedCollapsedState = localStorage.getItem('navCollapsed');
          if (savedCollapsedState === 'true') {
            fixedSideNav.classList.add('collapsed');
          }
        }
        
        // 在滚动时显示/隐藏右侧导航栏并更新活动链接
        function updateFixedSideNav() {
          // 在滚动超过300px后显示右侧导航栏
          if (window.scrollY > 300) {
            fixedSideNav.style.display = 'block';
            // 使用淡入动画
            setTimeout(() => {
              fixedSideNav.style.opacity = '1';
            }, 50);
          } else {
            fixedSideNav.style.opacity = '0';
            // 淡出后隐藏
            setTimeout(() => {
              if (window.scrollY <= 300) {
                fixedSideNav.style.display = 'none';
              }
            }, 300);
          }
          
          // 更新活动链接
          let currentSection = '';
          for (const section of sectionsForNav) {
            const el = document.getElementById(section.id);
            if (el && el.getBoundingClientRect().top <= window.innerHeight * 0.33) {
              currentSection = section.name;
            }
          }
          
          fixedNavLinks.forEach(link => {
            const section = link.getAttribute('data-section');
            link.classList.toggle('active', section === currentSection);
          });
        }
        
        window.addEventListener('scroll', updateFixedSideNav);
        window.addEventListener('resize', updateFixedSideNav);
        // 初始化调用
        updateFixedSideNav();
      });
    </script>

    <!-- 导航栏 -->
    <nav class="navbar">
      <ul>
        <li><a href="#section1" class="nav-link">Homepage</a></li>
        <li><a href="#section4" class="nav-link">Overview</a></li>
        <li><a href="#section5" class="nav-link">Trade Partners</a></li>
        <li><a href="#section6" class="nav-link">Key Commodities</a></li>
        <li><a href="#section7" class="nav-link">Transport Modes</a></li>
        <!-- <li><a href="#section8" class="nav-link">Insights</a></li> -->
        <li><a href="#section9" class="nav-link">Our Team</a></li>
      </ul>
    </nav>

    <!-- 右侧固定悬浮导航栏 -->
    <nav class="fixed-side-nav" id="fixed-side-nav">
      <ul class="fixed-side-menu">
        <li><a href="#section1" class="fixed-nav-link" data-title="Homepage"></a></li>
        <li><a href="#section4" class="fixed-nav-link" data-title="Overview"></a></li>
        <li><a href="#section5" class="fixed-nav-link" data-title="Trade Partners"></a></li>
        <li><a href="#section6" class="fixed-nav-link" data-title="Commodities"></a></li>
        <li><a href="#section7" class="fixed-nav-link" data-title="Transport"></a></li>
        <li><a href="#section9" class="fixed-nav-link" data-title="Team"></a></li>
        <li><a href="#top" class="fixed-nav-link back-to-top" data-title="Back to Top"></a></li>
      </ul>
    </nav>

    <!-- 主要内容区域 -->
    <main>
      <section id="section1" class="full-page hero-section" style="position:relative;overflow:hidden;display:flex;align-items:flex-start;justify-content:center;min-height:100vh;background:transparent;">
        <div id="threejs-bg" style="position:absolute;left:0;top:0;width:100%;height:100%;z-index:0;pointer-events:none;"></div>
        <!-- 添加倒影容器 -->
        <div id="threejs-reflection" style="position:absolute;left:0;top:100%;width:100%;height:100%;z-index:0;pointer-events:none;transform:scaleY(-1);opacity:0.3;background:linear-gradient(to bottom, rgba(0,0,0,0.1), transparent);"></div>
        <div class="hero-content" style="position:relative;z-index:2;display:flex;flex-direction:column;align-items:flex-start;justify-content:flex-start;max-width:1200px;margin:0 auto;padding-top:5vh;padding-left:0;">
          <div id="lottie-title" style="width:1800px;max-width:99vw;height:400px;min-height:200px;display:flex;align-items:center;justify-content:flex-start;pointer-events:none;margin-bottom:0;margin-left:-400px;">
            <div id="lottie-title-player" style="width:1800px;max-width:99vw;height:400px;"></div>
          </div>
          <p class="hero-desc highlight-desc" style="margin-top:-50px;margin-bottom:0;font-size:1.25rem;margin-left:120px;text-shadow:0 2px 4px rgba(0,0,0,0.8), 0 0 10px rgba(0,0,0,0.7), 0 0 20px rgba(0,0,0,0.7);color:#fff;font-weight:500;">
            An Exploration Of The Impact Of Brexit On The Global Commodity Import And Export Trade Network.
          </p>
        </div>
      </section>

      <section id="section1b" class="full-page hero-section" style="position:relative;overflow:hidden;display:flex;align-items:flex-start;justify-content:center;min-height:60vh;background:transparent;">
        <video autoplay muted loop playsinline id="bg-video"
          style="position:relative;width:60vw;height:auto;max-width:1200px;max-height:100vh;object-fit:cover;z-index:0;border-radius:1.5rem;box-shadow:0 4px 32px rgba(0,0,0,0.18);border:4px solid #444;margin-top:35vh;margin-bottom:20vh;">
          <source src="public/cover.mp4" type="video/mp4">
          Your browser does not support the video tag.
        </video>
      </section>

      <script>
        lottie.loadAnimation({
          container: document.getElementById('lottie-title-player'),
          renderer: 'svg',
          loop: true,
          autoplay: true,
          path: 'https://raw.githubusercontent.com/Cihshee/CASA0003_minnni_project/main/public/Bouncing-period-remix.json'
        });
      </script>

      <section id="section2" class="full-page">
        <div class="content brexit-vote-section">
          <div class="brexit-container">
            <div class="brexit-text">
              <h2>Brexit Referendum Results</h2>
              <p>The UK's decision to leave the European Union was determined by a historic referendum on June 23, 2016. The vote revealed significant regional variations in Brexit support across the country:</p>
              <ul>
                <li>Scotland and Northern Ireland predominantly voted to remain</li>
                <li>England and Wales showed stronger support for leaving</li>
                <li>London stood out as a remain stronghold within England</li>
              </ul>
              <p>This regional divide has had lasting implications for UK's trade patterns and economic relationships.</p>
            </div>
            <div id="brexit-map" class="brexit-map" style="position: relative; z-index: 10;"></div>
          </div>
        </div>
      </section>

      <script>
        document.addEventListener('DOMContentLoaded', function() {
          const MAPBOX_TOKEN = 'pk.eyJ1IjoieWl4aW5nLWxpIiwiYSI6ImNtN3FtNWh6YjA0ancybnM4aGxjZnlheTEifQ.sKwaoIMQR65VQmYDbnu2MQ';
          const MAPBOX_STYLE = 'mapbox://styles/yixing-li/cmaa8uo1j00j001sgc3051vxu';

          // 定义投票数据
          const votingData = {
            'Scotland': {
              seats: 6,
              distribution: ['remain', 'remain', 'remain', 'leave', 'other', 'other'],
              center: [-4.2026, 57.8907],
              offset: [-180, 0],
              stats: {
                remain: '62%',
                leave: '38%',
                turnout: '67.2%'
              },
              regionId: 'UKM'
            },
            'N Ireland': {
              seats: 3,
              distribution: ['remain', 'remain', 'leave'],
              center: [-6.4923, 54.7877],
              offset: [-160, 0],
              note: 'yet to declare',
              regionId: 'UKN'
            },
            'NE England': {
              seats: 3,
              distribution: ['remain', 'remain', 'leave'],
              center: [-1.6761, 54.9783],
              offset: [-160, 0],
              regionId: 'UKC'
            },
            'Yorkshire & the Humber': {
              seats: 6,
              distribution: ['remain', 'remain', 'remain', 'leave', 'leave', 'other'],
              center: [-1.0872, 53.9591],
              offset: [-180, 0],
              regionId: 'UKE'
            },
            'NW England': {
              seats: 8,
              distribution: ['remain', 'remain', 'remain', 'leave', 'leave', 'other', 'other', 'other'],
              center: [-2.7779, 54.4442],
              offset: [-160, -20],
              regionId: 'UKD'
            },
            'East Midlands': {
              seats: 5,
              distribution: ['remain', 'remain', 'remain', 'leave', 'other'],
              center: [-0.8451, 52.7954],
              offset: [-160, 0],
              regionId: 'UKF'
            },
            'West Midlands': {
              seats: 7,
              distribution: ['remain', 'remain', 'remain', 'remain', 'leave', 'leave', 'other'],
              center: [-2.1957, 52.4751],
              offset: [-180, 0],
              regionId: 'UKG'
            },
            'East of England': {
              seats: 7,
              distribution: ['remain', 'remain', 'remain', 'other', 'other', 'leave', 'other'],
              center: [0.5421, 52.1911],
              offset: [20, 0],
              regionId: 'UKH'
            },
            'Wales': {
              seats: 4,
              distribution: ['remain', 'remain', 'leave', 'leave'],
              center: [-3.7837, 52.1307],
              offset: [-160, 0],
              regionId: 'UKL'
            },
            'London': {
              seats: 8,
              distribution: ['other', 'other', 'other', 'remain', 'remain', 'leave', 'leave', 'other'],
              center: [-0.1276, 51.5072],
              offset: [20, 20],
              regionId: 'UKI'
            },
            'SW England': {
              seats: 6,
              distribution: ['remain', 'remain', 'remain', 'other', 'leave', 'other'],
              center: [-3.9999, 50.7772],
              offset: [-160, 20],
              regionId: 'UKK'
            },
            'SE England': {
              seats: 10,
              distribution: ['remain', 'remain', 'remain', 'remain', 'remain', 'leave', 'leave', 'other', 'other', 'other'],
              center: [-0.5596, 51.1781],
              offset: [20, -20],
              regionId: 'UKJ'
            }
          };

          // 创建Map
          mapboxgl.accessToken = MAPBOX_TOKEN;
          const map = new mapboxgl.Map({
            container: 'brexit-map',
            style: MAPBOX_STYLE,
            center: [-2, 54],
            zoom: 5.2,
            interactive: true
          });

          // 当地图加载完成后设置数据和图层
          map.on('load', function() {
            // 加载英国NUTS1区域数据
            map.addSource('uk-regions', {
              type: 'geojson',
              data: 'https://raw.githubusercontent.com/deldersveld/topojson/master/countries/united-kingdom/uk-nuts-1.json'
            });

            // 添加区域填充图层
            map.addLayer({
              'id': 'region-fills',
              'type': 'fill',
              'source': 'uk-regions',
              'layout': {},
              'paint': {
                'fill-color': [
                  'case',
                  ['boolean', ['feature-state', 'hover'], false],
                  'rgba(255, 255, 255, 0.2)',
                  'rgba(0, 0, 0, 0.0)'
                ],
                'fill-outline-color': [
                  'case',
                  ['boolean', ['feature-state', 'hover'], false],
                  '#ffffff',
                  'rgba(255, 255, 255, 0.4)'
                ],
                'fill-opacity': 0.7
              }
            });

            // 添加区域边界图层
            map.addLayer({
              'id': 'region-borders',
              'type': 'line',
              'source': 'uk-regions',
              'layout': {},
              'paint': {
                'line-color': 'rgba(255, 255, 255, 0.5)',
                'line-width': 1
              }
            });

            // 添加区域标签
            const markers = {};
            let hoveredStateId = null;
            
            // 鼠标悬停交互
            map.on('mousemove', 'region-fills', (e) => {
              if (e.features.length > 0) {
                if (hoveredStateId !== null) {
                  map.setFeatureState(
                    { source: 'uk-regions', id: hoveredStateId },
                    { hover: false }
                  );
                }
                hoveredStateId = e.features[0].id;
                map.setFeatureState(
                  { source: 'uk-regions', id: hoveredStateId },
                  { hover: true }
                );
                
                // 获取当前区域的属性
                const properties = e.features[0].properties;
                const regionCode = properties.NUTS_ID;
                
                // 找出与该区域代码匹配的投票数据区域
                const matchingRegion = Object.entries(votingData).find(([name, data]) => 
                  data.regionId === regionCode
                );
                
                if (matchingRegion) {
                  const [regionName, regionData] = matchingRegion;
                  // 高亮显示对应的标记
                  if (markers[regionName]) {
                    markers[regionName].getElement().classList.add('highlight');
                  }
                }
              }
            });
            
            map.on('mouseleave', 'region-fills', () => {
              if (hoveredStateId !== null) {
                map.setFeatureState(
                  { source: 'uk-regions', id: hoveredStateId },
                  { hover: false }
                );
                
                // 移除所有标记的高亮
                Object.values(markers).forEach(marker => {
                  marker.getElement().querySelector('.region-marker').classList.remove('highlight');
                });
              }
              hoveredStateId = null;
            });
            
            // 鼠标点击区域
            map.on('click', 'region-fills', (e) => {
              if (e.features.length > 0) {
                const properties = e.features[0].properties;
                const regionCode = properties.NUTS_ID;
                
                // 找出与该区域代码匹配的投票数据区域
                const matchingRegion = Object.entries(votingData).find(([name, data]) => 
                  data.regionId === regionCode
                );
                
                if (matchingRegion) {
                  const [regionName, regionData] = matchingRegion;
                  // 动画滚动到标记位置
                  map.flyTo({
                    center: regionData.center,
                    zoom: 6,
                    duration: 1000
                  });
                  
                  // 高亮显示对应的标记
                  if (markers[regionName]) {
                    const markerEl = markers[regionName].getElement();
                    markerEl.querySelector('.region-marker').classList.add('highlight');
                    
                    // 3秒后自动移除高亮
                    setTimeout(() => {
                      markerEl.querySelector('.region-marker').classList.remove('highlight');
                    }, 3000);
                    
                    // 展示详细统计信息
                    const statsEl = markerEl.querySelector('.region-stats');
                    if (statsEl) {
                      statsEl.style.display = 'block';
                      setTimeout(() => {
                        statsEl.style.display = '';
                      }, 3000);
                    }
                  }
                }
              }
            });
            
            // 改善光标反馈
            map.on('mouseenter', 'region-fills', () => {
              map.getCanvas().style.cursor = 'pointer';
            });
            
            map.on('mouseleave', 'region-fills', () => {
              map.getCanvas().style.cursor = '';
            });

            // 为每个区域添加标记
            Object.entries(votingData).forEach(([region, data], index) => {
              setTimeout(() => {
                const el = document.createElement('div');
                el.className = 'region-marker';
                el.style.animationDelay = `${index * 0.2}s`;
                
                const label = document.createElement('div');
                label.className = 'region-label';
                label.textContent = `${region} - ${data.seats}`;
                
                if (data.note) {
                  const note = document.createElement('div');
                  note.className = 'region-note';
                  note.textContent = data.note;
                  label.appendChild(note);
                }

                const distributionEl = document.createElement('div');
                distributionEl.className = 'vote-distribution';
                data.distribution.forEach(vote => {
                  const dot = document.createElement('span');
                  dot.className = `vote-dot ${vote}`;
                  distributionEl.appendChild(dot);
                });

                if (data.stats) {
                  const statsEl = document.createElement('div');
                  statsEl.className = 'region-stats';
                  
                  const stats = [
                    ['Remain', data.stats.remain],
                    ['Leave', data.stats.leave],
                    ['Turnout', data.stats.turnout]
                  ];

                  stats.forEach(([label, value]) => {
                    const row = document.createElement('div');
                    row.className = 'stats-row';
                    row.innerHTML = `
                      <span class="stats-label">${label}:</span>
                      <span class="stats-value">${value}</span>
                    `;
                    statsEl.appendChild(row);
                  });

                  el.appendChild(statsEl);
                }

                el.appendChild(label);
                el.appendChild(distributionEl);

                // 创建标记容器
                const markerDiv = document.createElement('div');
                markerDiv.className = 'marker-container';
                markerDiv.setAttribute('data-region', region);
                
                // 添加连接线
                const line = document.createElement('div');
                line.className = 'connector-line';
                
                // 应用偏移量到标记上
                if (data.offset) {
                  const length = Math.sqrt(data.offset[0] * data.offset[0] + data.offset[1] * data.offset[1]);
                  const angle = Math.atan2(data.offset[1], data.offset[0]) + Math.PI/2;
                  
                  line.style.height = `${length}px`;
                  line.style.transform = `rotate(${angle}rad)`;
                  
                  el.style.transform = `translate(${data.offset[0]}px, ${data.offset[1]}px)`;
                }
                
                markerDiv.appendChild(line);
                markerDiv.appendChild(el);
                
                // 创建标记并添加到地图
                const marker = new mapboxgl.Marker({
                  element: markerDiv,
                  anchor: 'center'
                })
                  .setLngLat(data.center)
                  .addTo(map);
                
                // 存储标记引用以便后续交互
                markers[region] = marker;
                
                // 为标记添加点击事件
                el.addEventListener('click', () => {
                  map.flyTo({
                    center: data.center,
                    zoom: 6,
                    duration: 1000
                  });
                  
                  el.classList.add('highlight');
                  setTimeout(() => {
                    el.classList.remove('highlight');
                  }, 3000);
                });
              }, index * 150);
            });
          });
        });
      </script>

      <section id="section4" class="full-page">
        <div class="content">
          <!-- 使用 Country Scale 组件 -->
          <div id="country-scale-container"></div>
        </div>
      </section>

      <section id="section5" class="full-page"> 
        <div class="content">
          <!-- 使用 Region Scale 组件 -->
          <div id="region-scale-container"></div>
        </div>
      </section>

      <section id="section6" class="full-page">
        <div class="content">
          <div id="goods-types-container"></div>
          <div id="goods-type-detail-section"></div>
        </div>
      </section>

      <section id="section7" class="full-page" style="min-height: 100vh;">
        <div class="content-transport">
          <!-- 使用 Transportation 组件 -->
          <div id="transport-container"></div>
        </div>
      </section>

      <!-- <section id="section8" class="full-page">
        <div class="content">
          
        </div>
      </section> -->

      <section id="section9" class="full-page">
        <div class="content">
          <h2 class="section-title">Our Team</h2>
          <div class="team-container">
            <div class="team-member">
              <div class="avatar-frame">
                <img src="public/img/team/cui.png" alt="team1" class="avatar-img">
              </div>
              <h3 class="member-name">Yiyao Cui</h3>
              <a href="https://github.com/Cihshee" class="member-link" target="_blank">Github page</a>
            </div>
            <div class="team-member">
              <div class="avatar-frame">
                <img src="public/img/team/chu.png" alt="team2" class="avatar-img">
              </div>
              <h3 class="member-name">Tianqi Chu</h3>
              <a href="https://github.com/vicky424" class="member-link" target="_blank">Github page</a>
            </div>
            <div class="team-member">
              <div class="avatar-frame">
                <img src="public/img/team/li.jpg" alt="team3" class="avatar-img">
              </div>
              <h3 class="member-name">Yixing(Vera) Li</h3>
              <a href="https://github.com/VeraLi0710" class="member-link" target="_blank">Github page</a>
            </div>
            <div class="team-member">
              <div class="avatar-frame">
                <img src="public/img/team/liu.png" alt="team4" class="avatar-img">
              </div>
              <h3 class="member-name">Scarlett Liu</h3>
              <a href="https://github.com/Scarlett-Cococo" class="member-link" target="_blank">Github page</a>
            </div>

          </div>
          <div class="footer-links">
            <a href="https://github.com/Cihshee/CASA0003_minnni_project" class="icon-link" target="_blank">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
              </svg>
            </a>
            <a href="https://www.ucl.ac.uk/bartlett/casa/" class="icon-link" target="_blank">
              <img src="public/img/CASAlogo.png" alt="CASA Logo" class="casa-logo">
            </a>
          </div>
          <div class="copyright">
            Copyright © Centre for Advanced Spatial Analysis, University College London 2025
          </div>
        </div>
      </section>

    <script>
      // 加载 Country Scale 组件
      fetch('src/components/CountryScale/CountryScale.html')
        .then(response => response.text())
        .then(html => {
          document.getElementById('country-scale-container').innerHTML = html;
          // 加载组件动画脚本
          const script = document.createElement('script');
          script.src = 'src/components/CountryScale/CountryScale.js';
          document.body.appendChild(script);
        });

      // 加载 Region Scale 组件
      fetch('src/components/RegionScale/RegionScale.html')
        .then(response => response.text())
        .then(html => {
          document.getElementById('region-scale-container').innerHTML = html;
          // 加载组件动画脚本
          const script = document.createElement('script');
          script.src = 'src/components/RegionScale/RegionScale.js';
          document.body.appendChild(script);
        });

      // 加载 Goods Types 组件
      fetch('src/components/GoodsType/GoodsType.html')
        .then(response => response.text())
        .then(html => {
          document.getElementById('goods-types-container').innerHTML = html;
          // 加载组件动画脚本
          const script = document.createElement('script');
          script.src = 'src/components/GoodsType/GoodsType.js';
          document.body.appendChild(script);
        });

      // 加载 Transportation 组件
      fetch('src/components/Transport/Transport.html')
        .then(response => response.text())
        .then(html => {
          document.getElementById('transport-container').innerHTML = html;
          // 加载组件动画脚本
          const script = document.createElement('script');
          script.src = 'src/components/Transport/Transport.js';
          document.body.appendChild(script);
        });

    </script>
    <script src="script.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      // 删除原有的自动吸附和自动滑动功能代码
      // 仅保留基本的部分用于侧边导航点的正常工作
      (function() {
        const sections = Array.from(document.querySelectorAll('.full-page'));
        
        function findCurrentSection() {
          let idx = 0;
          for (let i = 0; i < sections.length; i++) {
            const rect = sections[i].getBoundingClientRect();
            if (rect.top <= window.innerHeight * 0.33) idx = i;
          }
          return idx;
        }
        
        // 保留滚动位置监听以更新侧边导航点状态
        window.addEventListener('scroll', function() {
          const currentIdx = findCurrentSection();
          const dots = Array.from(document.querySelectorAll('.side-nav-dot'));
          dots.forEach((d, i) => d.classList.toggle('active', i === currentIdx));
        });
        
        // 保留点击侧边导航点的功能，但使用普通滚动
        const dots = Array.from(document.querySelectorAll('.side-nav-dot'));
        dots.forEach((dot, i) => {
          dot.addEventListener('click', e => {
            e.preventDefault();
            const sectionId = dot.getAttribute('data-target');
            const section = document.getElementById(sectionId);
            if (section) {
              window.scrollTo({
                top: section.offsetTop,
                behavior: 'smooth'
              });
            }
          });
        });
      })();
    </script>

    <!-- three.js 雾气城市背景脚本，只渲染到首页section1 -->
    <script type="module">
      import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.153.0/+esm';
      
      (function() {
        const bgDiv = document.getElementById('threejs-bg');
        if (!bgDiv) return;
        let width = bgDiv.offsetWidth, height = bgDiv.offsetHeight;
        // three.js 场景
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0xcad6e6, 0.018);
        const camera = new THREE.PerspectiveCamera(60, width/height, 1, 1000);
        camera.position.set(0, 40, 120);
        const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
        renderer.setClearColor(0xcad6e6, 0);
        renderer.setSize(width, height);
        bgDiv.appendChild(renderer.domElement);
        // 创建城市
        const city = new THREE.Group();
        for (let i = 0; i < 400; i++) {
          const geometry = new THREE.BoxGeometry(4, Math.random()*30+10, 4);
          const material = new THREE.MeshLambertMaterial({ color: 0x3a3a3a });
          const mesh = new THREE.Mesh(geometry, material);
          mesh.position.x = (Math.random()-0.5)*200;
          mesh.position.z = (Math.random()-0.5)*200;
          mesh.position.y = geometry.parameters.height/2 - 10;
          city.add(mesh);
        }
        scene.add(city);
        // 灯光
        const light = new THREE.DirectionalLight(0xffffff, 0.7);
        light.position.set(100, 200, 100);
        scene.add(light);
        scene.add(new THREE.AmbientLight(0xffffff, 0.5));
        // 雾气平面 - 使用程序生成的纹理而不是外部图像
        const fogMaterial = new THREE.MeshLambertMaterial({
          color: 0xffffff,
          transparent: true,
          opacity: 0.3,
          depthWrite: false
        });
        
        // 创建程序化雾气纹理 - 代替外部图像
        const canvas = document.createElement('canvas');
        canvas.width = 512;
        canvas.height = 512;
        const ctx = canvas.getContext('2d');
        // 创建放射渐变
        const gradient = ctx.createRadialGradient(256, 256, 0, 256, 256, 256);
        gradient.addColorStop(0, 'rgba(255, 255, 255, 0.8)');
        gradient.addColorStop(0.5, 'rgba(255, 255, 255, 0.3)');
        gradient.addColorStop(1, 'rgba(255, 255, 255, 0)');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, 512, 512);
        
        // 添加一些噪点
        for (let i = 0; i < 5000; i++) {
          const x = Math.random() * 512;
          const y = Math.random() * 512;
          const r = Math.random() * 1.5;
          ctx.beginPath();
          ctx.arc(x, y, r, 0, Math.PI * 2);
          ctx.fillStyle = `rgba(255, 255, 255, ${Math.random() * 0.1})`;
          ctx.fill();
        }
        
        // 使用画布作为纹理
        const fogTexture = new THREE.CanvasTexture(canvas);
        fogMaterial.map = fogTexture;
        
        const fogPlane = new THREE.Mesh(
          new THREE.PlaneGeometry(400, 400),
          fogMaterial
        );
        fogPlane.position.y = 5;
        fogPlane.rotation.x = -Math.PI/2;
        scene.add(fogPlane);
        // 动画
        function animate() {
          city.rotation.y += 0.0008;
          renderer.render(scene, camera);
          requestAnimationFrame(animate);
        }
        animate();
        // 响应窗口大小
        window.addEventListener('resize', function() {
          width = bgDiv.offsetWidth;
          height = bgDiv.offsetHeight;
          camera.aspect = width/height;
          camera.updateProjectionMatrix();
          renderer.setSize(width, height);
        });
      })();
    </script>

    <script>
      // 在three.js初始化后添加
      (function() {
        const bgDiv = document.getElementById('threejs-bg');
        const reflectionDiv = document.getElementById('threejs-reflection');
        
        // 监听three.js渲染
        const observer = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
              // 当three.js canvas被添加时，克隆它到倒影容器
              const canvas = bgDiv.querySelector('canvas');
              if (canvas && !reflectionDiv.querySelector('canvas')) {
                const reflectionCanvas = canvas.cloneNode(true);
                reflectionDiv.appendChild(reflectionCanvas);
              }
            }
          });
        });
        
        observer.observe(bgDiv, { childList: true });
      })();
    </script>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // 添加交互效果
        const regions = document.querySelectorAll('g[id]');
        regions.forEach(region => {
          region.addEventListener('mouseover', function() {
            this.style.opacity = '0.8';
          });
          region.addEventListener('mouseout', function() {
            this.style.opacity = '1';
          });
        });

        // 添加连接线动画
        const lines = document.querySelectorAll('.connection-line');
        lines.forEach(line => {
          line.style.strokeDashoffset = '4';
          line.style.animation = 'dash 20s linear infinite';
        });
      });
    </script>
  </body>
</html>
