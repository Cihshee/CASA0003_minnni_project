<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Brexit Commodity Import and Export Network</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="src/components/Transport/Transport.css">
    <link rel="stylesheet" href="src/components/CountryScale/CountryScale.css">
    <link rel="stylesheet" href="src/components/RegionScale/RegionScale.css">
    <link rel="stylesheet" href="src/components/GoodsType/GoodsType.css">
    <!-- Mapbox CSS and JS -->
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css' rel='stylesheet' />
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js'></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/scrollama"></script>
    <!-- 添加网站favicon -->
    <link rel="icon" href="public/img/CASAlogo.svg" type="image/svg+xml">
    <link rel="shortcut icon" href="public/img/CASAlogo.svg" type="image/svg+xml">
    <script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    
    <style>
      /* 视频背景增强效果 */
      .video-background {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1000;
        overflow: hidden;
        pointer-events: none;
      }
      
      .video-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          rgba(255, 255, 255, 0.249) 0%,
          rgba(255, 255, 255, 0.15) 10%,
          rgba(255, 255, 255, 0.1) 20%,
          rgba(255, 255, 255, 0.05) 35%,
          rgba(255, 255, 255, 0.02) 50%,
          rgba(0, 0, 0, 0) 70%
        );
        pointer-events: none;
        z-index: 1;
      }
      
      .video-background video {
        position: absolute;
        top: 50%;
        left: 50%;
        min-width: 100%;
        min-height: 100%;
        width: auto;
        height: auto;
        transform: translateX(-50%) translateY(-50%);
        object-fit: cover;
        opacity: 0.25;
        will-change: transform;
        -webkit-backface-visibility: hidden;
        backface-visibility: hidden;
      }
      
      /* 为各部分增加专属背景 */
      .section-background {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -999;
        overflow: hidden;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.5s ease;
      }
      
      .section-background video {
        position: absolute;
        top: 50%;
        left: 50%;
        min-width: 100%;
        min-height: 100%;
        width: auto;
        height: auto;
        transform: translateX(-50%) translateY(-50%);
        object-fit: cover;
      }
      
      /* 确保所有内容有一个正的z-index */
      .navbar, .side-nav, .hero-content, .content, .content-transport {
        position: relative;
        z-index: 1;
      }

      .brexit-vote-section {
        padding: 2rem;
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        margin: 2rem auto;
        max-width: 1400px;
        width: 100%;
        box-sizing: border-box;
      }

      .brexit-container {
        display: flex;
        gap: 3rem;
        align-items: flex-start;
        justify-content: center;
        min-height: 600px;
      }

      .brexit-text {
        flex: 0 0 500px;
        padding: 2rem;
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        height: 600px; /* 与地图高度一致 */
        display: flex;
        flex-direction: column;
        justify-content: space-between; /* 均匀分布内容 */
        overflow: hidden;
      }

      .brexit-text h2 {
        color: #fff;
        font-size: 2.8rem; /* 增大标题字号 */
        margin-bottom: 2rem; /* 增加标题下方间距 */
      }

      .brexit-text p {
        color: #fff;
        font-size: 1.05rem; /* 增大正文字号 */
        line-height: 1.5;
        margin-bottom: 1rem;
      }

      .brexit-text ul {
        color: #fff;
        margin: 1rem 0 5rem; /* 增加列表上下间距 */
        padding-left: 1.2rem;
      }

      .brexit-text li {
        margin: 0.5rem 0; /* 增加列表项间距 */
        font-size: 1.05rem; /* 增大列表字号 */
        line-height: 1.5;
      }

      .brexit-map {
        flex: 0 0 700px;
        height: 600px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 15px;
        position: relative;
        z-index: 10;
        overflow: hidden;
      }

      .uk-outline {
        fill: #2a2a2a;
        stroke: #fff;
        stroke-width: 1;
      }

      .connector {
        stroke: #fff;
        stroke-width: 1;
      }

      .seat {
        stroke: #fff;
        stroke-width: 0.5;
      }

      .seat.remain {
        fill: #00BCD4;
      }

      .seat.leave {
        fill: #F44336;
      }

      .seat.other {
        fill: #FFC107;
      }

      text {
        fill: #fff;
        font-family: 'Inter', sans-serif;
        font-size: 12px;
      }

      .note {
        fill: #aaa;
        font-size: 10px;
      }

      .region {
        transition: opacity 0.3s ease;
      }

      .region:hover {
        opacity: 0.8;
        cursor: pointer;
      }

      .region-marker {
        background: rgba(0, 0, 0, 0.85);
        padding: 8px;
        border-radius: 4px;
        white-space: nowrap;
        color: #fff;
        font-size: 12px;
        pointer-events: auto;
        z-index: 100;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        backdrop-filter: blur(4px);
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      }

      .region-marker.highlight {
        transform: scale(1.1);
        background: rgba(255, 255, 255, 0.95);
        color: #000;
        box-shadow: 0 4px 16px rgba(255, 255, 255, 0.5);
        z-index: 101;
      }

      .region-label {
        margin-bottom: 4px;
        font-weight: 500;
      }

      .vote-distribution {
        display: flex;
        gap: 2px;
      }

      .vote-dot {
        width: 16px;
        height: 16px;
        border-radius: 3px;
      }

      .vote-dot.yellow { background: #f7f48b; }
      .vote-dot.red { background: #F44336; }
      .vote-dot.blue { background: #2196F3; }
      .vote-dot.cyan { background: #00BCD4; }
      .vote-dot.green { background: #4CAF50; }
      .vote-dot.orange { background: #FFC107; }
      .vote-dot.darkgreen { background: #137a2b; }

      .connector-line {
        fill: none;
        stroke: rgba(255, 255, 255, 0.8);
        stroke-width: 1.5;
        pointer-events: none;
        stroke-dasharray: 4,4;
        animation: dash 20s linear infinite;
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      }

      .connector-dot {
        fill: rgba(255, 255, 255, 0.8);
        stroke: rgba(255, 255, 255, 0.4);
        stroke-width: 1;
        pointer-events: none;
        r: 3;
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      }

      .connector-line.fade-in,
      .connector-dot.fade-in {
        opacity: 1;
        transform: translateY(0);
      }

      .connector-group {
        opacity: 0;
        transition: opacity 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      }

      .connector-group.fade-in {
        opacity: 1;
      }

      .brexit-text.visible {
        opacity: 1;
        transform: translateY(0);
      }

      .brexit-text p.visible {
        opacity: 1;
        transform: translateY(0);
      }

      .brexit-text .vote-content,
      .brexit-text .brexit-content {
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      }

      .brexit-text .vote-content.visible,
      .brexit-text .brexit-content.visible {
        opacity: 1;
        transform: translateY(0);
      }

      .region-marker.visible {
        opacity: 1;
        transform: translateY(0);
      }

      .connector-group.highlight .connector-line {
        stroke: rgba(255, 255, 255, 1);
        stroke-width: 3;
        stroke-dasharray: none;
        filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.5));
      }

      .connector-group.highlight .connector-dot {
        fill: rgba(255, 255, 255, 1);
        stroke: rgba(255, 255, 255, 0.8);
        r: 5;
        filter: drop-shadow(0 0 4px rgba(255, 255, 255, 0.5));
      }

      .view-toggle {
        position: absolute;
        top: 20px;
        right: 20px;
        display: flex;
        gap: 10px;
        z-index: 100;
      }

      .view-button {
        background: rgba(0, 0, 0, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: #fff;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .view-button:hover {
        background: rgba(0, 0, 0, 0.8);
        border-color: rgba(255, 255, 255, 0.4);
      }

      .view-button.active {
        background: rgba(255, 255, 255, 0.2);
        border-color: rgba(255, 255, 255, 0.6);
      }

      .view-button svg {
        width: 16px;
        height: 16px;
        fill: currentColor;
      }

      @keyframes fadeOut {
        from { opacity: 1; }
        to { opacity: 0; }
      }

      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }

      .fade-out {
        animation: fadeOut 0.5s forwards;
      }

      .fade-in {
        animation: fadeIn 0.5s forwards;
      }

      .party-legend {
        position: absolute;
        top: 20px;
        left: 20px;
        display: flex;
        gap: 8px;
        z-index: 100;
        background: rgba(0, 0, 0, 0.6);
        padding: 8px;
        border-radius: 4px;
        transition: opacity 0.5s ease;
      }

      .party-item {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-size: 12px;
        font-weight: 500;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .party-item.Con { background: #2196F3; }
      .party-item.Bxt { background: #00BCD4; }
      .party-item.Grn { background: #4CAF50; }
      .party-item.Lab { background: #F44336; }
      .party-item.LD { background: #FFC107; }
      .party-item.PldC { background: #137a2b; }
      .party-item.SNP { background: #f7f48b; color: #000; }

      .region-fills-hover {
        transition: all 0.2s ease;
      }
    </style>
  </head>
  <body>
    <!-- 主视频背景（第一个视频）- 首页 -->
    <div class="video-background" id="main-background">
      <div class="video-overlay"></div>
      <video autoplay muted loop playsinline id="homepage-background-video">
        <source src="https://raw.githubusercontent.com/Cihshee/CASA0003_minnni_project/main/public/1.mp4" type="video/mp4">
        Your browser does not support the video tag.
      </video>
    </div>
    
    <!-- 第二个视频背景 - 其他部分 -->
    <div class="section-background" id="sections-background">
      <video autoplay muted loop playsinline id="sections-background-video">
        <source src="https://raw.githubusercontent.com/Cihshee/CASA0003_minnni_project/main/public/2.mp4" type="video/mp4">
        Your browser does not support the video tag.
      </video>
    </div>
    
    <!-- Side Navigation Dots -->
    <div class="side-nav" id="side-nav">
      <div class="side-nav-dot" data-target="section1"></div>
      <div class="side-nav-dot" data-target="section1b"></div>
      <div class="side-nav-dot" data-target="section4"></div>
      <div class="side-nav-dot" data-target="section5"></div>
      <div class="side-nav-dot" data-target="section6"></div>
      <div class="side-nav-dot" data-target="section7"></div>
      <!-- <div class="side-nav-dot" data-target="section8"></div> -->
      <div class="side-nav-dot" data-target="section9"></div>
    </div>
    
    <!-- Load Lottie library and initialize animations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
    <script>
      // Initialize background animation
      document.addEventListener('DOMContentLoaded', function() {
        // Background animation
        const anim = lottie.loadAnimation({
          container: document.getElementById('background-animation'),
          renderer: 'svg',
          loop: true,
          autoplay: true,
          path: 'https://raw.githubusercontent.com/Cihshee/CASA0003_minnni_project/main/public/Chevrons-moving-down.json',
          rendererSettings: {
            preserveAspectRatio: 'xMidYMid slice',
            className: 'lottie-svg-fullscreen'
          }
        });
        
        // 在动画加载完成后减慢速度
        anim.addEventListener('DOMLoaded', function() {
          // 设置为0.3倍速，使动画更慢
          anim.setSpeed(0.3);
          console.log('Animation speed set to 0.3');
        });
        
        // Ensure the animation container covers the desired viewport area
        function resizeAnimation() {
          const container = document.getElementById('background-animation');
          container.style.width = (window.innerWidth * 0.9) + 'px';
          container.style.height = window.innerHeight + 'px';
          container.style.left = '5%';
          container.style.right = '5%';
        }
        
        // Call resize on load and on window resize
        resizeAnimation();
        window.addEventListener('resize', resizeAnimation);
      });
    </script>

    <script>
      // Side nav scroll and highlight logic
      const dots = Array.from(document.querySelectorAll('.side-nav-dot'));
      const sections = [
        'section1','section1b','section4','section5','section6','section7','section8','section9'
      ].map(id => document.getElementById(id));
      
      function updateActiveDot() {
        let idx = 0;
        const scrollY = window.scrollY || window.pageYOffset;
        for (let i = 0; i < sections.length; i++) {
          if (sections[i]) {
            const rect = sections[i].getBoundingClientRect();
            if (rect.top <= window.innerHeight * 0.33) idx = i;
          }
        }
        dots.forEach((d, i) => d.classList.toggle('active', i === idx));
        
        // 根据当前部分切换背景视频
        const mainBackground = document.getElementById('main-background');
        const sectionsBackground = document.getElementById('sections-background');
        
        if (idx <= 1) { // 首页部分显示第一个视频
          mainBackground.style.opacity = 1;
          sectionsBackground.style.opacity = 0;
        } else { // 其他部分显示第二个视频
          mainBackground.style.opacity = 0;
          sectionsBackground.style.opacity = 1;
        }
      }
      
      window.addEventListener('scroll', updateActiveDot);
      window.addEventListener('resize', updateActiveDot);
      // 初始化时立即调用一次
      document.addEventListener('DOMContentLoaded', updateActiveDot);
      
      dots.forEach((dot, i) => {
        dot.addEventListener('click', e => {
          e.preventDefault();
          if (sections[i]) sections[i].scrollIntoView({behavior:'smooth'});
        });
      });
    </script>

    <!-- 右侧固定导航栏的脚本 -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const fixedSideNav = document.getElementById('fixed-side-nav');
        const fixedNavLinks = document.querySelectorAll('.fixed-nav-link');
        const sectionsForNav = [
          { id: 'section1', name: 'homepage' },
          { id: 'section4', name: 'overview' },
          { id: 'section5', name: 'partners' },
          { id: 'section6', name: 'commodities' },
          { id: 'section7', name: 'transport' },
          { id: 'section9', name: 'team' }
        ];
        
        const backToTopLink = document.querySelector('.back-to-top');
        if (backToTopLink) {
          backToTopLink.addEventListener('click', function(e) {
            e.preventDefault();
            window.scrollTo({ top: 0, behavior: 'smooth' });
          });
        }
        
        // 折叠/展开导航栏功能
        const toggleNavBtn = document.getElementById('toggle-nav-btn');
        if (toggleNavBtn) {
          toggleNavBtn.addEventListener('click', function() {
            fixedSideNav.classList.toggle('collapsed');
            // 保存用户折叠状态的偏好
            localStorage.setItem('navCollapsed', fixedSideNav.classList.contains('collapsed'));
          });
          
          // 加载用户之前的折叠状态偏好
          const savedCollapsedState = localStorage.getItem('navCollapsed');
          if (savedCollapsedState === 'true') {
            fixedSideNav.classList.add('collapsed');
          }
        }
        
        // 在滚动时显示/隐藏右侧导航栏并更新活动链接
        function updateFixedSideNav() {
          // 在滚动超过300px后显示右侧导航栏
          if (window.scrollY > 300) {
            fixedSideNav.style.display = 'block';
            // 使用淡入动画
            setTimeout(() => {
              fixedSideNav.style.opacity = '1';
            }, 50);
          } else {
            fixedSideNav.style.opacity = '0';
            // 淡出后隐藏
            setTimeout(() => {
              if (window.scrollY <= 300) {
                fixedSideNav.style.display = 'none';
              }
            }, 300);
          }
          
          // 更新活动链接
          let currentSection = '';
          for (const section of sectionsForNav) {
            const el = document.getElementById(section.id);
            if (el && el.getBoundingClientRect().top <= window.innerHeight * 0.33) {
              currentSection = section.name;
            }
          }
          
          fixedNavLinks.forEach(link => {
            const section = link.getAttribute('data-section');
            link.classList.toggle('active', section === currentSection);
          });
        }
        
        window.addEventListener('scroll', updateFixedSideNav);
        window.addEventListener('resize', updateFixedSideNav);
        // 初始化调用
        updateFixedSideNav();
      });
    </script>

    <!-- 导航栏 -->
    <nav class="navbar">
      <ul>
        <li><a href="#section1" class="nav-link">Homepage</a></li>
        <li><a href="#section4" class="nav-link">Overview</a></li>
        <li><a href="#section5" class="nav-link">Trade Partners</a></li>
        <li><a href="#section6" class="nav-link">Key Commodities</a></li>
        <li><a href="#section7" class="nav-link">Transport Modes</a></li>
        <!-- <li><a href="#section8" class="nav-link">Insights</a></li> -->
        <li><a href="#section9" class="nav-link">Our Team</a></li>
      </ul>
    </nav>

    <!-- 右侧固定悬浮导航栏 -->
    <nav class="fixed-side-nav" id="fixed-side-nav">
      <ul class="fixed-side-menu">
        <li><a href="#section1" class="fixed-nav-link" data-title="Homepage"></a></li>
        <li><a href="#section4" class="fixed-nav-link" data-title="Overview"></a></li>
        <li><a href="#section5" class="fixed-nav-link" data-title="Trade Partners"></a></li>
        <li><a href="#section6" class="fixed-nav-link" data-title="Commodities"></a></li>
        <li><a href="#section7" class="fixed-nav-link" data-title="Transport"></a></li>
        <li><a href="#section9" class="fixed-nav-link" data-title="Team"></a></li>
        <li><a href="#top" class="fixed-nav-link back-to-top" data-title="Back to Top"></a></li>
      </ul>
    </nav>

    <!-- 主要内容区域 -->
    <main>
      <section id="section1" class="full-page hero-section" style="position:relative;overflow:hidden;display:flex;align-items:flex-start;justify-content:center;min-height:100vh;background:transparent;">
        <div id="threejs-bg" style="position:absolute;left:0;top:0;width:100%;height:100%;z-index:0;pointer-events:none;"></div>
        <!-- 添加倒影容器 -->
        <div id="threejs-reflection" style="position:absolute;left:0;top:100%;width:100%;height:100%;z-index:0;pointer-events:none;transform:scaleY(-1);opacity:0.3;background:linear-gradient(to bottom, rgba(0,0,0,0.1), transparent);"></div>
        <div class="hero-content" style="position:relative;z-index:2;display:flex;flex-direction:column;align-items:flex-start;justify-content:flex-start;max-width:1200px;margin:0 auto;padding-top:5vh;padding-left:0;">
          <div id="lottie-title" style="width:1800px;max-width:99vw;height:400px;min-height:200px;display:flex;align-items:center;justify-content:flex-start;pointer-events:none;margin-bottom:0;margin-left:-400px;">
            <div id="lottie-title-player" style="width:1800px;max-width:99vw;height:400px;"></div>
          </div>
          <p class="hero-desc highlight-desc" style="margin-top:-50px;margin-bottom:0;font-size:1.25rem;margin-left:120px;text-shadow:0 2px 4px rgba(0,0,0,0.8), 0 0 10px rgba(0,0,0,0.7), 0 0 20px rgba(0,0,0,0.7);color:#fff;font-weight:500;">
            An Exploration Of The Impact Of Brexit On The Global Commodity Import And Export Trade Network.
          </p>
        </div>
      </section>

      <section id="section1b" class="full-page hero-section" style="position:relative;overflow:hidden;display:flex;align-items:flex-start;justify-content:center;min-height:60vh;background:transparent;">
        <video autoplay muted loop playsinline id="bg-video"
          style="position:relative;width:60vw;height:auto;max-width:1200px;max-height:100vh;object-fit:cover;z-index:0;border-radius:1.5rem;box-shadow:0 4px 32px rgba(0,0,0,0.18);border:4px solid #444;margin-top:35vh;margin-bottom:20vh;">
          <source src="public/cover.mp4" type="video/mp4">
          Your browser does not support the video tag.
        </video>
      </section>

      <script>
        lottie.loadAnimation({
          container: document.getElementById('lottie-title-player'),
          renderer: 'svg',
          loop: true,
          autoplay: true,
          path: 'https://raw.githubusercontent.com/Cihshee/CASA0003_minnni_project/main/public/Bouncing-period-remix.json'
        });
      </script>

      <section id="section2" class="full-page">
        <div class="content brexit-vote-section">
          <div class="brexit-container">
            <div class="brexit-text">
              <h2>"Brexit"</h2>
              <div class="vote-content">
                <p>The 2016 Brexit referendum revealed stark regional divisions across the UK:</p>
                <ul>
                  <li>Scotland and Northern Ireland voted strongly to remain</li>
                  <li>England and Wales backed leaving the EU</li>
                  <li>London emerged as a remain stronghold</li>
                </ul>
              </div>
              <div class="brexit-content">
                <p>The 2020 Brexit implementation transformed UK's international trade:</p>
                <ul>
                  <li>New trade and customs frameworks</li>
                  <li>Changed movement of goods</li>
                  <li>Reshaped business partnerships</li>
                </ul>
              </div>
            </div>
            <div id="brexit-map" class="brexit-map">
              <div class="party-legend">
                <div class="party-item Con">Con</div>
                <div class="party-item Bxt">Bxt</div>
                <div class="party-item Grn">Grn</div>
                <div class="party-item Lab">Lab</div>
                <div class="party-item LD">LD</div>
                <div class="party-item PldC">PldC</div>
                <div class="party-item SNP">SNP</div>
              </div>
              <div class="view-toggle">
                <button class="view-button active" data-view="vote">
                  <svg viewBox="0 0 24 24"><path d="M18 13h-.68l-2 2h1.91L19 17H5l1.78-2h2.05l-2-2H6l-3 3v4c0 1.1.89 2 1.99 2H19c1.1 0 2-.89 2-2v-4l-3-3zm-1-5.05l-4.95 4.95-3.54-3.54 4.95-4.95L17 7.95zm-4.24-5.66L6.39 8.66c-.39.39-.39 1.02 0 1.41l4.95 4.95c.39.39 1.02.39 1.41 0l6.36-6.36c.39-.39.39-1.02 0-1.41L14.16 2.3c-.38-.4-1.01-.4-1.4-.01z"/></svg>
                  2016 Vote
                </button>
                <button class="view-button" data-view="brexit">
                  <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
                  2020 Brexit
                </button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <script>
        document.addEventListener('DOMContentLoaded', function() {
          const MAPBOX_TOKEN = 'pk.eyJ1IjoieWl4aW5nLWxpIiwiYSI6ImNtN3FtNWh6YjA0ancybnM4aGxjZnlheTEifQ.sKwaoIMQR65VQmYDbnu2MQ';
          const MAPBOX_STYLE = 'mapbox://styles/yixing-li/cmaa8uo1j00j001sgc3051vxu';

          // 创建Map
          mapboxgl.accessToken = MAPBOX_TOKEN;
          const map = new mapboxgl.Map({
            container: 'brexit-map',
            style: MAPBOX_STYLE,
            center: [-2.5, 55.5],  // 向上移动中心点
            zoom: 4.5,  // 稍微拉远视角
            interactive: true,
            boxZoom: false,
            dragRotate: false,
            pitchWithRotate: false,
            touchZoomRotate: false
          });

          // 并行加载四个文件，合成区域数据
          Promise.all([
            fetch('https://raw.githubusercontent.com/Cihshee/CASA0003_minnni_project/main/public/data/countries.geojson').then(r => r.json()),
            fetch('https://raw.githubusercontent.com/Cihshee/CASA0003_minnni_project/main/public/data/England_boundaries.json').then(r => r.json()),
            fetch('https://raw.githubusercontent.com/Cihshee/CASA0003_minnni_project/main/public/data/Scotland_boundaries.json').then(r => r.json()),
            fetch('https://raw.githubusercontent.com/Cihshee/CASA0003_minnni_project/main/public/data/Wales_boundaries.json').then(r => r.json())
          ]).then(([countries, englandTopo, scotlandTopo, walesTopo]) => {
            // 确保所有数据使用相同的坐标系统 (WGS84)
            const ireland = countries.features.find(f => f.properties.name === "Ireland");
            
            // 转换TopoJSON到GeoJSON并确保坐标系统一致
            const england = topojson.feature(englandTopo, englandTopo.objects[Object.keys(englandTopo.objects)[0]]);
            const scotland = topojson.feature(scotlandTopo, scotlandTopo.objects[Object.keys(scotlandTopo.objects)[0]]);
            const wales = topojson.feature(walesTopo, walesTopo.objects[Object.keys(walesTopo.objects)[0]]);

            // 合并所有feature
            const features = [];
            if (ireland) features.push(ireland);
            features.push(...england.features);
            features.push(...scotland.features);
            features.push(...wales.features);

            // 为每个feature添加唯一ID
            features.forEach((f, i) => {
              f.id = i;
              // 确保properties存在
              f.properties = f.properties || {};
            });

            const merged = { 
              type: "FeatureCollection", 
              features,
              crs: {
                type: "name",
                properties: {
                  name: "urn:ogc:def:crs:OGC:1.3:CRS84"
                }
              }
            };

            // 地图加载后添加数据源
            map.on('load', function() {
              map.addSource('uk-regions', {
                type: 'geojson',
                data: merged,
                generateId: true
              });

              // 清除所有高亮状态
              function clearAllHighlights() {
                map.setFilter('region-fills-hover', ['==', ['get', 'EER13NM'], '']);
                markers.forEach(data => {
                  if (data.element) {
                    data.element.classList.remove('highlight');
                    if (data.group) {
                      data.group.classList.remove('highlight');
                    }
                  }
                });
              }

              // 高亮特定区域
              function highlightRegion(regionName) {
                clearAllHighlights();
                
                // 高亮地图区域
                map.setFilter('region-fills-hover', ['==', ['get', 'EER13NM'], regionName]);
                
                // 高亮对应的标签和连接线
                const marker = markers.get(regionName);
                if (marker) {
                  marker.element.classList.add('highlight');
                  marker.group.classList.add('highlight');
                }
              }

              // 启动自动高亮动画
              function startAutoHighlight() {
                if (window.highlightInterval) {
                  clearInterval(window.highlightInterval);
                }

                const regions = Array.from(markers.keys());
                let lastRegion = null;

                function getRandomRegion() {
                  let region;
                  do {
                    region = regions[Math.floor(Math.random() * regions.length)];
                  } while (region === lastRegion && regions.length > 1);
                  lastRegion = region;
                  return region;
                }

                // 立即高亮第一个区域
                highlightRegion(getRandomRegion());

                // 每800ms切换一次高亮区域
                window.highlightInterval = setInterval(() => {
                  if (currentView === 'vote') {
                    highlightRegion(getRandomRegion());
                  } else {
                    clearInterval(window.highlightInterval);
                    window.highlightInterval = null;
                  }
                }, 320);
              }

              // 添加视图切换逻辑
              const viewButtons = document.querySelectorAll('.view-button');
              const partyLegend = document.querySelector('.party-legend');
              let currentView = 'vote';

              // 定义两个视图的相机位置
              const viewPositions = {
                initial: {
                  center: [0, 50],
                  zoom: 2,
                  duration: 2000
                },
                vote: {
                  center: [-2.5, 55.5],
                  zoom: 4.5,
                  duration: 2000
                },
                brexit: {
                  center: [0, 50],
                  zoom: 3,
                  duration: 2000
                }
              };

              // 处理视图切换
              function switchView(targetView, skipAnimation = false, startHighlight = false) {
                if (currentView === targetView) return;
                
                // 停止自动高亮动画
                if (window.highlightInterval) {
                  clearInterval(window.highlightInterval);
                  window.highlightInterval = null;
                }

                // 清除所有高亮状态
                clearAllHighlights();
                
                // 更新按钮状态
                viewButtons.forEach(btn => {
                  btn.classList.toggle('active', btn.dataset.view === targetView);
                });

                const voteContent = document.querySelector('.vote-content');
                const brexitContent = document.querySelector('.brexit-content');

                // 开始转场动画
                if (targetView === 'brexit') {
                  // 淡出标记和连接线
                  markers.forEach(data => {
                    if (data.element) {
                      data.element.classList.add('fade-out');
                      data.group.classList.add('fade-out');
                    }
                  });
                  partyLegend.classList.add('fade-out');

                  // 显示Brexit内容但保持vote内容可见
                  setTimeout(() => {
                    brexitContent.classList.add('visible');
                  }, 400);

                  // 等待淡出完成后移动地图
                  setTimeout(() => {
                    map.flyTo({
                      ...viewPositions[targetView],
                      essential: true
                    });

                    // 隐藏所有视觉元素
                    markers.forEach(data => {
                      if (data.element) {
                        data.element.style.display = 'none';
                        data.group.style.display = 'none';
                      }
                    });
                    partyLegend.style.display = 'none';
                    
                    // 隐藏所有连接线和标记
                    document.querySelectorAll('.connector-line, .connector-dot').forEach(el => {
                      el.style.display = 'none';
                    });
                  }, 500);
                } else {
                  // 从Brexit视图返回Vote视图
                  map.flyTo({
                    ...viewPositions[targetView],
                    essential: true
                  });

                  // 隐藏Brexit内容但保持vote内容可见
                  brexitContent.classList.remove('visible');

                  // 等待地图移动完成后显示元素
                  setTimeout(() => {
                    // 显示所有连接线和标记
                    document.querySelectorAll('.connector-line, .connector-dot').forEach(el => {
                      el.style.display = '';
                    });

                    markers.forEach(data => {
                      if (data.element) {
                        data.element.style.display = '';
                        data.group.style.display = '';
                        data.element.classList.remove('fade-out');
                        data.element.classList.add('fade-in');
                        data.group.classList.remove('fade-out');
                        data.group.classList.add('fade-in');
                      }
                    });
                    partyLegend.style.display = '';
                    partyLegend.classList.remove('fade-out');
                    partyLegend.classList.add('fade-in');
                  }, skipAnimation ? 0 : 1000);
                }

                currentView = targetView;
              }

              // 添加按钮点击事件
              viewButtons.forEach(button => {
                button.addEventListener('click', () => {
                  // 手动切换时不启动高亮动画
                  switchView(button.dataset.view, false, false);
                });
              });

              // 添加区域填充图层
              map.addLayer({
                'id': 'region-fills',
                'type': 'fill',
                'source': 'uk-regions',
                'layout': {},
                'paint': {
                  'fill-color': 'rgba(0, 0, 0, 0)',
                  'fill-outline-color': 'rgba(255, 255, 255, 0.4)'
                }
              });

              // 添加高亮图层
              map.addLayer({
                'id': 'region-fills-hover',
                'type': 'fill',
                'source': 'uk-regions',
                'layout': {},
                'paint': {
                  'fill-color': 'rgba(255, 255, 255, 0.4)',
                  'fill-outline-color': '#ffffff',
                  'fill-opacity': ['case',
                    ['boolean', ['==', ['get', 'EER13NM'], ''], false],
                    0,
                    0.6
                  ]
                },
                'filter': ['==', ['get', 'EER13NM'], '']
              });

              // 投票数据，包含党派缩写和颜色
              const votingData = {
                "Scotland": { 
                  seats: 6, 
                  distribution: [
                    {party:"SNP", color:"yellow"}, {party:"SNP", color:"yellow"}, {party:"Lab", color:"red"}, 
                    {party:"Lab", color:"red"}, {party:"Lab", color:"red"}, {party:"Con", color:"blue"}
                  ],
                  labelOffset: [40, -50]
                },
                "Northern Ireland": { 
                  seats: 3, 
                  note: "yet to declare",
                  labelOffset: [-90, -20]
                },
                "North East": { 
                  seats: 3, 
                  distribution: [
                    {party:"Bxt", color:"cyan"}, {party:"Bxt", color:"cyan"}, {party:"Lab", color:"red"}
                  ],
                  labelOffset: [120, -40]
                },
                "Yorkshire and The Humber": { 
                  seats: 6, 
                  distribution: [
                    {party:"Bxt", color:"cyan"}, {party:"Bxt", color:"cyan"}, {party:"Bxt", color:"cyan"}, 
                    {party:"Lab", color:"red"}, {party:"Con", color:"blue"}, {party:"LD", color:"orange"}
                  ],
                  labelOffset: [110, -20]
                },
                "North West": { 
                  seats: 8, 
                  distribution: [
                    {party:"Bxt", color:"cyan"}, {party:"Bxt", color:"cyan"}, {party:"Bxt", color:"cyan"}, 
                    {party:"Lab", color:"red"}, {party:"Lab", color:"red"}, {party:"Con", color:"blue"}, 
                    {party:"LD", color:"orange"}, {party:"Grn", color:"green"}
                  ],
                  labelOffset: [-110, -10]
                },
                "West Midlands": { 
                  seats: 7, 
                  distribution: [
                    {party:"Bxt", color:"cyan"}, {party:"Bxt", color:"cyan"}, {party:"Lab", color:"red"}, 
                    {party:"Lab", color:"red"}, {party:"Con", color:"blue"}, {party:"LD", color:"orange"}, 
                    {party:"Grn", color:"green"}
                  ],
                  labelOffset: [-130, 60]
                },
                "Wales": { 
                  seats: 4, 
                  distribution: [
                    {party:"Bxt", color:"cyan"}, {party:"Lab", color:"red"}, {party:"PlaidC", color:"darkgreen"}, 
                    {party:"Con", color:"blue"}
                  ],
                  labelOffset: [-110, -30]
                },
                "South West": { 
                  seats: 6, 
                  distribution: [
                    {party:"Bxt", color:"cyan"}, {party:"Bxt", color:"cyan"}, {party:"Bxt", color:"cyan"}, 
                    {party:"LD", color:"orange"}, {party:"Con", color:"blue"}, {party:"Grn", color:"green"}
                  ],
                  labelOffset: [-60, 70]
                },
                "South East": { 
                  seats: 10, 
                  distribution: [
                    {party:"Bxt", color:"cyan"}, {party:"Bxt", color:"cyan"}, {party:"Bxt", color:"cyan"}, 
                    {party:"Con", color:"blue"}, {party:"Con", color:"blue"}, {party:"LD", color:"orange"}, 
                    {party:"LD", color:"orange"}, {party:"Grn", color:"green"}, {party:"Lab", color:"red"}, 
                    {party:"Lab", color:"red"}
                  ],
                  labelOffset: [130, 30]
                },
                "East Midlands": { 
                  seats: 5, 
                  distribution: [
                    {party:"Bxt", color:"cyan"}, {party:"Bxt", color:"cyan"}, {party:"Con", color:"blue"}, 
                    {party:"Lab", color:"red"}, {party:"LD", color:"orange"}
                  ],
                  labelOffset: [130, 30]
                },
                "East of England": { 
                  seats: 7, 
                  distribution: [
                    {party:"Bxt", color:"cyan"}, {party:"Bxt", color:"cyan"}, {party:"Con", color:"blue"}, 
                    {party:"Con", color:"blue"}, {party:"LD", color:"orange"}, {party:"Grn", color:"green"}, 
                    {party:"Lab", color:"red"}
                  ],
                  labelOffset: [110, -10]
                },
                "London": { 
                  seats: 8, 
                  distribution: [
                    {party:"Lab", color:"red"}, {party:"Lab", color:"red"}, {party:"Lab", color:"red"}, 
                    {party:"Lab", color:"red"}, {party:"LD", color:"orange"}, {party:"LD", color:"orange"}, 
                    {party:"Grn", color:"green"}, {party:"Con", color:"blue"}
                  ],
                  labelOffset: [50, -30]
                }
              };

              // 地区名称映射（GeoJSON中的名称到我们的数据中的名称）
              const regionNameMapping = {
                "Scotland": "Scotland",
                "Northern Ireland": "Northern Ireland",
                "North East": "North East",
                "Yorkshire and The Humber": "Yorkshire and The Humber",
                "North West": "North West",
                "West Midlands": "West Midlands",
                "Wales": "Wales",
                "South West": "South West",
                "South East": "South East",
                "East Midlands": "East Midlands",
                "East of England": "East of England",
                "London": "London"
              };

              // 创建SVG容器
              const svgContainer = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
              svgContainer.style.position = 'absolute';
              svgContainer.style.top = '0';
              svgContainer.style.left = '0';
              svgContainer.style.width = '100%';
              svgContainer.style.height = '100%';
              svgContainer.style.pointerEvents = 'none';
              svgContainer.style.zIndex = '99';
              document.getElementById('brexit-map').appendChild(svgContainer);

              // 存储所有标记和连接线
              const markers = new Map();

              // 遍历每个地区创建标记
              merged.features.forEach(feature => {
                const regionName = feature.properties.EER13NM;
                if (!regionName) return;
                
                const mappedName = regionNameMapping[regionName];
                const data = votingData[mappedName];
                if (!data) return;

                // 计算地区中心点
                const center = turf.center(feature).geometry.coordinates;

                // 创建标记容器
                const markerEl = document.createElement('div');
                markerEl.className = 'region-marker';
                markerEl.setAttribute('data-region', regionName);

                // 添加地区名称和座位数
                const label = document.createElement('div');
                label.className = 'region-label';
                label.textContent = `${regionName} - ${data.seats}`;
                markerEl.appendChild(label);

                // 添加投票分布
                if (data.distribution) {
                  const distributionEl = document.createElement('div');
                  distributionEl.className = 'vote-distribution';
                  data.distribution.forEach(vote => {
                    const dot = document.createElement('div');
                    dot.className = `vote-dot ${vote.color}`;
                    distributionEl.appendChild(dot);
                  });
                  markerEl.appendChild(distributionEl);
                }

                // 创建标记并添加到地图
                const marker = new mapboxgl.Marker({
                  element: markerEl,
                  offset: data.labelOffset
                })
                .setLngLat(center)
                .addTo(map);

                // 创建连接线组
                const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                group.setAttribute('class', 'connector-group');
                
                // 创建连接线
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('class', 'connector-line');
                group.appendChild(path);

                // 创建端点圆点
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('class', 'connector-dot');
                circle.setAttribute('r', '3');
                group.appendChild(circle);

                svgContainer.appendChild(group);

                // 存储标记信息
                markers.set(regionName, {
                  marker,
                  center,
                  element: markerEl,
                  line: path,
                  dot: circle,
                  group: group
                });
              });

              // 更新连接线函数
              function updateConnectors() {
                const mapCanvas = map.getCanvas();
                const mapRect = mapCanvas.getBoundingClientRect();

                markers.forEach((data, regionName) => {
                  const { marker, center, line, dot, group, element } = data;
                  if (!marker || !center) return;

                  // 获取标签元素和它在地图上的位置
                  const markerEl = marker.getElement();

                  // 确保标签位置计算正确
                  try {
                    const markerRect = markerEl.getBoundingClientRect();
                    
                    // 计算地理中心点在屏幕上的位置
                    const centerPoint = map.project(center);
                    const start = {
                      x: centerPoint.x,
                      y: centerPoint.y
                    };

                    // 计算标签底部中心位置
                    const end = {
                      x: markerRect.left + markerRect.width / 2 - mapRect.left,
                      y: markerRect.top + markerRect.height - mapRect.top
                    };

                    // 计算连接线路径
                    // 使用直角连接线
                    const path = `
                      M ${start.x} ${start.y}
                      L ${start.x} ${end.y}
                      L ${end.x} ${end.y}
                    `;

                    // 更新路径和圆点
                    line.setAttribute('d', path);
                    dot.setAttribute('cx', start.x);
                    dot.setAttribute('cy', start.y);
                    
                    // 确保连接线组可见
                    group.style.display = 'block';
                    group.style.opacity = '1';
                  } catch (e) {
                    console.error("Error updating connector for region: " + regionName, e);
                  }
                });
              }

              // 监听地图事件
              map.on('move', updateConnectors);
              map.on('zoom', updateConnectors);
              map.on('style.load', updateConnectors);
              window.addEventListener('resize', updateConnectors);

              // 更新滚动动画，确保所有元素同时出现
              function addScrollAnimation() {
                const brexitSection = document.getElementById('section2');
                const brexitText = document.querySelector('.brexit-text');
                
                const observer = new IntersectionObserver((entries) => {
                  entries.forEach(entry => {
                    if (entry.isIntersecting) {
                      requestAnimationFrame(() => {
                        markers.forEach((data) => {
                          if (data.element) data.element.classList.add('visible');
                          if (data.group) data.group.classList.add('visible');
                        });
                        if (brexitText) {
                          brexitText.classList.add('visible');
                        }
                      });
                      
                      observer.unobserve(entry.target);
                    }
                  });
                }, { threshold: 0.2 });

                observer.observe(brexitSection);
              }

              // 初始化连接线并添加滚动动画
              map.once('load', () => {
                updateConnectors();
                addScrollAnimation();
              });

              // 鼠标悬停交互
              let hoveredRegionId = null;

              map.on('mousemove', 'region-fills', (e) => {
                if (e.features.length > 0) {
                  if (hoveredRegionId) {
                    map.setFilter('region-fills-hover', ['==', ['get', 'EER13NM'], '']);
                    const prevMarker = markers.get(hoveredRegionId);
                    if (prevMarker) {
                      prevMarker.element.style.transform = '';
                      prevMarker.element.style.background = '';
                      prevMarker.element.style.boxShadow = '';
                      prevMarker.group.querySelector('.connector-line').style.stroke = '';
                      prevMarker.group.querySelector('.connector-line').style.strokeWidth = '';
                      prevMarker.group.querySelector('.connector-dot').style.fill = '';
                      prevMarker.group.querySelector('.connector-dot').style.stroke = '';
                      prevMarker.group.querySelector('.connector-dot').setAttribute('r', '3');
                    }
                  }

                  hoveredRegionId = e.features[0].properties.EER13NM;
                  if (hoveredRegionId) {
                    map.setFilter('region-fills-hover', ['==', ['get', 'EER13NM'], hoveredRegionId]);
                    const marker = markers.get(hoveredRegionId);
                    if (marker) {
                      marker.element.style.transform = 'scale(1.05)';
                      marker.element.style.background = 'rgba(0, 0, 0, 0.95)';
                      marker.element.style.boxShadow = '0 4px 12px rgba(0,0,0,0.5)';
                      marker.group.querySelector('.connector-line').style.stroke = 'rgba(255, 255, 255, 1)';
                      marker.group.querySelector('.connector-line').style.strokeWidth = '2';
                      marker.group.querySelector('.connector-dot').style.fill = 'rgba(255, 255, 255, 1)';
                      marker.group.querySelector('.connector-dot').style.stroke = 'rgba(255, 255, 255, 0.6)';
                      marker.group.querySelector('.connector-dot').setAttribute('r', '4');
                    }
                  }
                }
              });

              map.on('mouseleave', 'region-fills', () => {
                if (hoveredRegionId) {
                  map.setFilter('region-fills-hover', ['==', ['get', 'EER13NM'], '']);
                  const prevMarker = markers.get(hoveredRegionId);
                  if (prevMarker) {
                    prevMarker.element.style.transform = '';
                    prevMarker.element.style.background = '';
                    prevMarker.element.style.boxShadow = '';
                    prevMarker.group.querySelector('.connector-line').style.stroke = '';
                    prevMarker.group.querySelector('.connector-line').style.strokeWidth = '';
                    prevMarker.group.querySelector('.connector-dot').style.fill = '';
                    prevMarker.group.querySelector('.connector-dot').style.stroke = '';
                    prevMarker.group.querySelector('.connector-dot').setAttribute('r', '3');
                  }
                }
                hoveredRegionId = null;
              });

              // 初始化地图位置和自动播放序列
              let hasPlayedSequence = false;

              // 创建Intersection Observer来检测地图区域的可见性
              const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                  if (entry.isIntersecting && !hasPlayedSequence) {
                    hasPlayedSequence = true;
                    
                    // 设置初始远景位置
                    map.jumpTo(viewPositions.initial);
                    
                    // 隐藏所有元素
                    markers.forEach(data => {
                      if (data.element) {
                        data.element.style.display = 'none';
                        data.group.style.display = 'none';
                      }
                    });
                    partyLegend.style.display = 'none';
                    document.querySelectorAll('.connector-line, .connector-dot').forEach(el => {
                      el.style.display = 'none';
                    });

                    // 显示2016投票内容
                    const voteContent = document.querySelector('.vote-content');
                    const brexitContent = document.querySelector('.brexit-content');
                    voteContent.classList.add('visible');
                    brexitContent.classList.remove('visible');

                    // 开始动画序列
                    setTimeout(() => {
                      map.flyTo({
                        ...viewPositions.vote,
                        duration: 1500
                      });
                      
                      setTimeout(() => {
                        markers.forEach(data => {
                          if (data.element) {
                            data.element.style.display = '';
                            data.element.classList.add('fade-in');
                            if (data.group) {
                              data.group.style.display = '';
                              data.group.classList.add('fade-in');
                            }
                          }
                        });
                        
                        partyLegend.style.display = '';
                        partyLegend.classList.add('fade-in');
                        
                        document.querySelectorAll('.connector-line, .connector-dot').forEach(el => {
                          el.style.display = '';
                          el.classList.add('fade-in');
                        });
                        
                        updateConnectors();
                        
                        setTimeout(() => {
                          startAutoHighlight();
                          
                          setTimeout(() => {
                            switchView('brexit', false, false);
                          }, 2000); // 减少等待时间从5000ms到3000ms
                        }, 400);
                      }, 1500);
                    }, 500);
                  }
                });
              }, { threshold: 0.5 });

              // 开始观察地图容器
              observer.observe(document.getElementById('brexit-map'));

              // 添加鼠标悬停暂停自动高亮的功能
              map.on('mousemove', 'region-fills', (e) => {
                if (e.features.length > 0) {
                  // 暂停自动高亮
                  if (window.highlightInterval) {
                    clearInterval(window.highlightInterval);
                    window.highlightInterval = null;
                  }

                  const regionName = e.features[0].properties.EER13NM;
                  if (regionName) {
                    highlightRegion(regionName);
                  }
                }
              });

              map.on('mouseleave', 'region-fills', () => {
                // 恢复自动高亮
                if (currentView === 'vote' && !window.highlightInterval) {
                  startAutoHighlight();
                }
              });
            });
          });
        });
      </script>

      <section id="section4" class="full-page">
        <div class="content">
          <!-- 使用 Country Scale 组件 -->
          <div id="country-scale-container"></div>
        </div>
      </section>

      <section id="section5" class="full-page"> 
        <div class="content">
          <!-- 使用 Region Scale 组件 -->
          <div id="region-scale-container"></div>
        </div>
      </section>

      <section id="section6" class="full-page">
        <div class="content">
          <div id="goods-types-container"></div>
          <div id="goods-type-detail-section"></div>
        </div>
      </section>

      <section id="section7" class="full-page" style="min-height: 100vh;">
        <div class="content-transport">
          <!-- 使用 Transportation 组件 -->
          <div id="transport-container"></div>
        </div>
      </section>

      <!-- <section id="section8" class="full-page">
        <div class="content">
          
        </div>
      </section> -->

      <section id="section9" class="full-page">
        <div class="content">
          <h2 class="section-title">Our Team</h2>
          <div class="team-container">
            <div class="team-member">
              <div class="avatar-frame">
                <img src="public/img/team/cui.png" alt="team1" class="avatar-img">
              </div>
              <h3 class="member-name">Yiyao Cui</h3>
              <a href="https://github.com/Cihshee" class="member-link" target="_blank">Github page</a>
            </div>
            <div class="team-member">
              <div class="avatar-frame">
                <img src="public/img/team/chu.png" alt="team2" class="avatar-img">
              </div>
              <h3 class="member-name">Tianqi Chu</h3>
              <a href="https://github.com/vicky424" class="member-link" target="_blank">Github page</a>
            </div>
            <div class="team-member">
              <div class="avatar-frame">
                <img src="public/img/team/li.jpg" alt="team3" class="avatar-img">
              </div>
              <h3 class="member-name">Yixing(Vera) Li</h3>
              <a href="https://github.com/VeraLi0710" class="member-link" target="_blank">Github page</a>
            </div>
            <div class="team-member">
              <div class="avatar-frame">
                <img src="public/img/team/liu.png" alt="team4" class="avatar-img">
              </div>
              <h3 class="member-name">Scarlett Liu</h3>
              <a href="https://github.com/Scarlett-Cococo" class="member-link" target="_blank">Github page</a>
            </div>

          </div>
          <div class="footer-links">
            <a href="https://github.com/Cihshee/CASA0003_minnni_project" class="icon-link" target="_blank">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
              </svg>
            </a>
            <a href="https://www.ucl.ac.uk/bartlett/casa/" class="icon-link" target="_blank">
              <img src="public/img/CASAlogo.png" alt="CASA Logo" class="casa-logo">
            </a>
          </div>
          <div class="copyright">
            Copyright © Centre for Advanced Spatial Analysis, University College London 2025
          </div>
        </div>
      </section>

    <script>
      // 加载 Country Scale 组件
      fetch('src/components/CountryScale/CountryScale.html')
        .then(response => response.text())
        .then(html => {
          document.getElementById('country-scale-container').innerHTML = html;
          // 加载组件动画脚本
          const script = document.createElement('script');
          script.src = 'src/components/CountryScale/CountryScale.js';
          document.body.appendChild(script);
        });

      // 加载 Region Scale 组件
      fetch('src/components/RegionScale/RegionScale.html')
        .then(response => response.text())
        .then(html => {
          document.getElementById('region-scale-container').innerHTML = html;
          // 加载组件动画脚本
          const script = document.createElement('script');
          script.src = 'src/components/RegionScale/RegionScale.js';
          document.body.appendChild(script);
        });

      // 加载 Goods Types 组件
      fetch('src/components/GoodsType/GoodsType.html')
        .then(response => response.text())
        .then(html => {
          document.getElementById('goods-types-container').innerHTML = html;
          // 加载组件动画脚本
          const script = document.createElement('script');
          script.src = 'src/components/GoodsType/GoodsType.js';
          document.body.appendChild(script);
        });

      // 加载 Transportation 组件
      fetch('src/components/Transport/Transport.html')
        .then(response => response.text())
        .then(html => {
          document.getElementById('transport-container').innerHTML = html;
          // 加载组件动画脚本
          const script = document.createElement('script');
          script.src = 'src/components/Transport/Transport.js';
          document.body.appendChild(script);
        });

    </script>
    <script src="script.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      // 删除原有的自动吸附和自动滑动功能代码
      // 仅保留基本的部分用于侧边导航点的正常工作
      (function() {
        const sections = Array.from(document.querySelectorAll('.full-page'));
        
        function findCurrentSection() {
          let idx = 0;
          for (let i = 0; i < sections.length; i++) {
            const rect = sections[i].getBoundingClientRect();
            if (rect.top <= window.innerHeight * 0.33) idx = i;
          }
          return idx;
        }
        
        // 保留滚动位置监听以更新侧边导航点状态
        window.addEventListener('scroll', function() {
          const currentIdx = findCurrentSection();
          const dots = Array.from(document.querySelectorAll('.side-nav-dot'));
          dots.forEach((d, i) => d.classList.toggle('active', i === currentIdx));
        });
        
        // 保留点击侧边导航点的功能，但使用普通滚动
        const dots = Array.from(document.querySelectorAll('.side-nav-dot'));
        dots.forEach((dot, i) => {
          dot.addEventListener('click', e => {
            e.preventDefault();
            const sectionId = dot.getAttribute('data-target');
            const section = document.getElementById(sectionId);
            if (section) {
              window.scrollTo({
                top: section.offsetTop,
                behavior: 'smooth'
              });
            }
          });
        });
      })();
    </script>

    <!-- three.js 雾气城市背景脚本，只渲染到首页section1 -->
    <script type="module">
      import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.153.0/+esm';
      
      (function() {
        const bgDiv = document.getElementById('threejs-bg');
        if (!bgDiv) return;
        let width = bgDiv.offsetWidth, height = bgDiv.offsetHeight;
        // three.js 场景
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0xcad6e6, 0.018);
        const camera = new THREE.PerspectiveCamera(60, width/height, 1, 1000);
        camera.position.set(0, 40, 120);
        const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
        renderer.setClearColor(0xcad6e6, 0);
        renderer.setSize(width, height);
        bgDiv.appendChild(renderer.domElement);
        // 创建城市
        const city = new THREE.Group();
        for (let i = 0; i < 400; i++) {
          const geometry = new THREE.BoxGeometry(4, Math.random()*30+10, 4);
          const material = new THREE.MeshLambertMaterial({ color: 0x3a3a3a });
          const mesh = new THREE.Mesh(geometry, material);
          mesh.position.x = (Math.random()-0.5)*200;
          mesh.position.z = (Math.random()-0.5)*200;
          mesh.position.y = geometry.parameters.height/2 - 10;
          city.add(mesh);
        }
        scene.add(city);
        // 灯光
        const light = new THREE.DirectionalLight(0xffffff, 0.7);
        light.position.set(100, 200, 100);
        scene.add(light);
        scene.add(new THREE.AmbientLight(0xffffff, 0.5));
        // 雾气平面 - 使用程序生成的纹理而不是外部图像
        const fogMaterial = new THREE.MeshLambertMaterial({
          color: 0xffffff,
          transparent: true,
          opacity: 0.3,
          depthWrite: false
        });
        
        // 创建程序化雾气纹理 - 代替外部图像
        const canvas = document.createElement('canvas');
        canvas.width = 512;
        canvas.height = 512;
        const ctx = canvas.getContext('2d');
        // 创建放射渐变
        const gradient = ctx.createRadialGradient(256, 256, 0, 256, 256, 256);
        gradient.addColorStop(0, 'rgba(255, 255, 255, 0.8)');
        gradient.addColorStop(0.5, 'rgba(255, 255, 255, 0.3)');
        gradient.addColorStop(1, 'rgba(255, 255, 255, 0)');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, 512, 512);
        
        // 添加一些噪点
        for (let i = 0; i < 5000; i++) {
          const x = Math.random() * 512;
          const y = Math.random() * 512;
          const r = Math.random() * 1.5;
          ctx.beginPath();
          ctx.arc(x, y, r, 0, Math.PI * 2);
          ctx.fillStyle = `rgba(255, 255, 255, ${Math.random() * 0.1})`;
          ctx.fill();
        }
        
        // 使用画布作为纹理
        const fogTexture = new THREE.CanvasTexture(canvas);
        fogMaterial.map = fogTexture;
        
        const fogPlane = new THREE.Mesh(
          new THREE.PlaneGeometry(400, 400),
          fogMaterial
        );
        fogPlane.position.y = 5;
        fogPlane.rotation.x = -Math.PI/2;
        scene.add(fogPlane);
        // 动画
        function animate() {
          city.rotation.y += 0.0008;
          renderer.render(scene, camera);
          requestAnimationFrame(animate);
        }
        animate();
        // 响应窗口大小
        window.addEventListener('resize', function() {
          width = bgDiv.offsetWidth;
          height = bgDiv.offsetHeight;
          camera.aspect = width/height;
          camera.updateProjectionMatrix();
          renderer.setSize(width, height);
        });
      })();
    </script>

    <script>
      // 在three.js初始化后添加
      (function() {
        const bgDiv = document.getElementById('threejs-bg');
        const reflectionDiv = document.getElementById('threejs-reflection');
        
        // 监听three.js渲染
        const observer = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
              // 当three.js canvas被添加时，克隆它到倒影容器
              const canvas = bgDiv.querySelector('canvas');
              if (canvas && !reflectionDiv.querySelector('canvas')) {
                const reflectionCanvas = canvas.cloneNode(true);
                reflectionDiv.appendChild(reflectionCanvas);
              }
            }
          });
        });
        
        observer.observe(bgDiv, { childList: true });
      })();
    </script>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // 添加交互效果
        const regions = document.querySelectorAll('g[id]');
        regions.forEach(region => {
          region.addEventListener('mouseover', function() {
            this.style.opacity = '0.8';
          });
          region.addEventListener('mouseout', function() {
            this.style.opacity = '1';
          });
        });

        // 添加连接线动画
        const lines = document.querySelectorAll('.connection-line');
        lines.forEach(line => {
          line.style.strokeDashoffset = '4';
          line.style.animation = 'dash 20s linear infinite';
        });
      });
    </script>

    <script>
      // 清除所有高亮状态
      function clearAllHighlights() {
        map.setFilter('region-fills-hover', ['==', ['get', 'EER13NM'], '']);
        markers.forEach(data => {
          if (data.element) {
            data.element.classList.remove('highlight');
            if (data.group) {
              data.group.classList.remove('highlight');
            }
          }
        });
      }

      // 高亮特定区域
      function highlightRegion(regionName) {
        clearAllHighlights();
        
        // 高亮地图区域
        map.setFilter('region-fills-hover', ['==', ['get', 'EER13NM'], regionName]);
        
        // 高亮对应的标签和连接线
        const marker = markers.get(regionName);
        if (marker) {
          marker.element.classList.add('highlight');
          marker.group.classList.add('highlight');
        }
      }

      // 启动自动高亮动画
      function startAutoHighlight() {
        if (window.highlightInterval) {
          clearInterval(window.highlightInterval);
        }

        const regions = Array.from(markers.keys());
        let lastRegion = null;

        function getRandomRegion() {
          let region;
          do {
            region = regions[Math.floor(Math.random() * regions.length)];
          } while (region === lastRegion && regions.length > 1);
          lastRegion = region;
          return region;
        }

        // 立即高亮第一个区域
        highlightRegion(getRandomRegion());

        // 每800ms切换一次高亮区域
        window.highlightInterval = setInterval(() => {
          if (currentView === 'vote') {
            highlightRegion(getRandomRegion());
          } else {
            clearInterval(window.highlightInterval);
            window.highlightInterval = null;
          }
        }, 800);
      }

      // 在初始动画序列中添加自动高亮启动
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting && !hasPlayedSequence) {
            hasPlayedSequence = true;
            
            // ... existing initial animation code ...
            
            setTimeout(() => {
              map.flyTo({
                ...viewPositions.vote,
                duration: 1500
              });
              
              setTimeout(() => {
                // ... existing element show code ...
                
                // 启动自动高亮
                setTimeout(() => {
                  startAutoHighlight();
                }, 500);
                
                setTimeout(() => {
                  switchView('brexit');
                }, 2000);
              }, 1500);
            }, 500);
          }
        });
      }, { threshold: 0.5 });

      // 添加鼠标悬停暂停自动高亮的功能
      map.on('mousemove', 'region-fills', (e) => {
        if (e.features.length > 0) {
          // 暂停自动高亮
          if (window.highlightInterval) {
            clearInterval(window.highlightInterval);
            window.highlightInterval = null;
          }

          const regionName = e.features[0].properties.EER13NM;
          if (regionName) {
            highlightRegion(regionName);
          }
        }
      });

      map.on('mouseleave', 'region-fills', () => {
        // 恢复自动高亮
        if (currentView === 'vote' && !window.highlightInterval) {
          startAutoHighlight();
        }
      });
    </script>
  </body>
</html>
